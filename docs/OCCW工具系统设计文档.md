# OCCW报价与销售分析系统设计文档

## 目录

1. [项目概述](#项目概述)
2. [需求设计](#需求设计)
3. [架构设计](#架构设计)
4. [功能设计](#功能设计)
5. [数据结构设计](#数据结构设计)
6. [转换规则详解](#转换规则详解)
7. [API设计](#api设计)
8. [界面设计](#界面设计)
9. [部署说明](#部署说明)
10. [版本更新记录](#版本更新记录)

---

## 项目概述

### 1.1 项目背景

OCCW报价与销售分析系统（OCCW Quote & Sales Analysis Platform）是一个综合性的Web应用平台，专门用于厨柜行业的报价管理和销售数据分析。该系统能够：

- **报价管理**：解析PDF格式的报价单文档，自动识别和转换产品SKU
- **价格管理**：管理OCCW价格表和映射关系，生成标准化报价单
- **销售分析**：完整的销售数据导入、转换、分析和可视化功能
- **客户类型分析**：新增客户类型和公司类型分析功能
- **智能过滤**：灵活的数据导入过滤条件配置，支持金额区间过滤
- **多语言界面**：支持中文、英文、法文三语言切换
- **数据可视化**：Chart.js图表展示销售趋势和转化率分析
- **用户权限管理**：管理员和普通用户权限分离
- **数据导出**：多格式数据导出（Excel、PDF）

### 1.2 系统特点

- **自动化处理**：减少手工转换的工作量和错误率
- **智能识别**：基于规则的SKU识别和转换
- **灵活配置**：支持自定义映射规则和价格管理
- **多语言支持**：适应国际化需求
- **现代化界面**：基于Bootstrap 5的响应式设计
- **客户洞察**：深度客户类型分析，支持零售vs批发对比

---

## 需求设计

### 2.1 功能需求

#### 2.1.1 核心功能需求

| 功能模块 | 描述 | 优先级 |
|---------|------|-------|
| PDF解析 | 解析上传的PDF报价单，提取产品信息 | P0 |
| SKU转换 | 将原始SKU转换为OCCW标准SKU | P0 |
| 价格查询 | 根据SKU查询OCCW价格表中的价格 | P0 |
| 报价生成 | 生成标准化的OCCW报价单 | P0 |
| 映射管理 | 管理SKU映射关系 | P1 |
| 价格管理 | 管理OCCW价格表 | P1 |
| 多语言支持 | 支持中英法三种语言 | P2 |
| **销售数据导入** | 导入Excel格式的销售订单数据 | P1 |
| **销售数据转换** | 将原始数据转换为标准化分析格式 | P1 |
| **销售业绩分析** | 销售员业绩统计和转化率分析 | P1 |
| **客户订单分析** | 客户转化率和订单趋势分析 | P1 |
| **客户类型分析** | 新增客户类型和公司类型分析 | P1 |
| **数据过滤系统** | 灵活的导入数据过滤条件配置 | P1 |
| **数据可视化** | 图表展示销售趋势和转化率 | P2 |

#### 2.1.2 业务需求

1. **准确性要求**
   - SKU识别准确率 ≥ 95%
   - 价格匹配准确率 ≥ 98%
   - 支持手动校正机制

2. **性能要求**
   - PDF解析时间 ≤ 30秒
   - 页面响应时间 ≤ 3秒
   - 支持并发用户数 ≥ 10

3. **兼容性要求**
   - 支持PDF 1.4+版本
   - 支持Excel .xlsx/.xls格式
   - 兼容主流浏览器

### 2.2 非功能需求

#### 2.2.1 性能需求

- **响应时间**：页面加载 < 3秒，API响应 < 1秒
- **并发处理**：支持10个并发用户
- **数据容量**：支持100万条价格记录
- **文件大小**：支持最大16MB的PDF文件

#### 2.2.2 安全需求

- **访问控制**：管理员密码保护
- **数据安全**：敏感数据加密存储
- **文件安全**：上传文件类型验证
- **会话管理**：安全的会话机制

#### 2.2.3 可用性需求

- **系统可用性**：99%正常运行时间
- **易用性**：直观的用户界面，操作步骤 ≤ 3步
- **容错性**：友好的错误提示和恢复机制
- **维护性**：模块化设计，便于扩展

---

## 架构设计

### 3.1 总体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   表示层(UI)     │    │   业务逻辑层     │    │    数据层       │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • 报价单上传页面 │◄──►│ • PDF解析服务   │◄──►│ • OCCW价格表    │
│ • SKU映射管理   │    │ • SKU转换服务   │    │ • SKU映射表     │
│ • 价格表管理    │    │ • 价格查询服务   │    │ • 配置文件      │
│ • 系统配置页面  │    │ • 报价生成服务   │    │ • 日志文件      │
│ • 多语言支持    │    │ • 权限管理服务   │    │ • 临时文件      │
│ • 客户类型分析  │    │ • 客户分析服务   │    │ • 分析数据      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3.2 技术架构

#### 3.2.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Bootstrap | 5.x | 响应式UI框架 |
| jQuery | 3.x | DOM操作和AJAX |
| Chart.js | 3.x | 数据可视化 |
| Font Awesome | 6.x | 图标库 |
| HTML5 | - | 页面结构 |
| CSS3 | - | 样式设计 |
| JavaScript | ES6+ | 交互逻辑 |

#### 3.2.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Flask | 2.x | Web框架 |
| Python | 3.8+ | 后端语言 |
| PyPDF2 | 3.x | PDF解析 |
| pandas | 1.x | 数据处理 |
| ReportLab | 3.x | PDF生成 |
| Gunicorn | 20.x | WSGI服务器 |

#### 3.2.3 数据存储

| 类型 | 技术 | 用途 |
|------|------|------|
| 结构化数据 | JSON文件 | 价格表、映射关系 |
| 配置数据 | Python配置文件 | 系统配置 |
| 临时数据 | 文件系统 | 上传文件缓存 |
| 日志数据 | 日志文件 | 系统日志 |

---

## 功能设计

### 4.1 报价单处理功能

#### 4.1.1 PDF上传与解析

**输入**：PDF格式的报价单文件
**输出**：结构化的产品数据

**处理流程**：
1. 文件上传验证（格式、大小）
2. PDF文本内容提取
3. 文本清理和格式化
4. 产品信息识别和提取
5. 数据结构化组织

### 4.2 SKU转换功能

#### 4.2.1 转换规则引擎

**规则类型**：
1. **直接映射**：一对一映射关系（通过SKU映射表）
2. **产品类型识别**：基于产品描述的类型判断
3. **硬编码规则**：预定义的产品类型转换规则

### 4.3 销售数据分析功能

#### 4.3.1 数据导入与过滤

**导入流程**：
1. Excel文件上传验证
2. 数据格式标准化
3. 应用导入过滤条件
4. 数据转换处理
5. 临时存储和持久化

**智能过滤系统**：
```python
# 支持的过滤条件
filter_conditions = {
    'import_filter_min_amount': 1000,           # 最小金额阈值
    'import_filter_sales_person': 'John,Mary',   # 销售人员（多选）
    'import_filter_customer': 'CustomerA',      # 客户过滤
    'import_filter_customer_company_type': '公司', # 客户公司类型（单选）
    'import_filter_customer_type': '零售,批发',   # 客户类型（多选）
    'import_filter_start_date': '2024-01-01',   # 开始日期
    'import_filter_end_date': '2024-12-31',     # 结束日期
    'import_filter_order_status': '销售订单,报价单' # 订单状态（多选）
}
```

#### 4.3.2 客户类型分析功能

**新增功能**：
1. **客户类型分析表**
   - 按客户类型统计订单和报价单数据
   - 计算数量转化率和金额转化率
   - 支持表格排序功能

2. **客户类型趋势图表**
   - 客户类型金额趋势图：横坐标为月份，纵坐标为各客户类型的订单和报价单金额
   - 客户类型数量趋势图：横坐标为月份，纵坐标为各客户类型的订单和报价单数量

3. **客户类型分布图表**
   - 客户类型金额占比图：各客户类型订单金额的占比分布
   - 客户类型数量占比图：各客户类型订单数量的占比分布

4. **零售与批发分析图表**
   - 零售与批发金额分析图：按客户公司类型汇总的订单和报价单金额
   - 零售与批发数量分析图：按客户公司类型汇总的订单和报价单数量

#### 4.3.3 数据转换与标准化

**转换规则**：
```python
def convert_sales_data(raw_data):
    """销售数据转换核心逻辑"""
    for record in raw_data:
        if record['订单状态'] == '销售订单':
            # 销售订单：订单金额=总计，报价单金额=总计
            record['订单金额'] = record['总计']
            record['报价单金额'] = record['总计']
            record['订单数量'] = 1
            record['报价单数量'] = 1
        elif record['订单状态'] == '报价单':
            # 报价单：订单金额=0，报价单金额=总计
            record['订单金额'] = 0
            record['报价单金额'] = record['总计']
            record['订单数量'] = 0
            record['报价单数量'] = 1
    return converted_data
```

**客户类型数据预处理**：
```python
def preprocess_customer_type_data(df):
    """预处理客户类型数据"""
    # 处理客户/公司类型列
    if '客户/公司类型' in df.columns:
        df['客户/公司类型'] = df['客户/公司类型'].fillna('未设置')
        df['客户/公司类型'] = df['客户/公司类型'].replace('', '未设置')
    else:
        df['客户/公司类型'] = '未设置'

    # 处理客户/类型列
    if '客户/类型' in df.columns:
        df['客户/类型'] = df['客户/类型'].fillna('未设置')
        df['客户/类型'] = df['客户/类型'].replace('', '未设置')
    else:
        df['客户/类型'] = '未设置'

    return df
```

#### 4.3.4 销售业绩分析

**分析维度**：
1. **销售员业绩分析**
   - 订单金额统计
   - 报价单金额统计
   - 数量转化率
   - 金额转化率
   - 平均毛利率

2. **客户订单分析**
   - 客户转化率统计
   - 订单金额排名
   - 客户价值分析

3. **客户类型分析**（新增）
   - 客户类型转化率统计
   - 客户类型订单趋势
   - 零售vs批发对比分析

4. **时间趋势分析**
   - 按月/按周销售趋势
   - 转化率变化趋势
   - 业绩对比分析

#### 4.3.5 数据可视化

**图表类型**：
1. **订单金额转化率分析**
   - 主Y轴：订单金额、总报价金额（实线）
   - 副Y轴：金额转化率（虚线）

2. **订单数量转化率分析**
   - 主Y轴：订单数、总报价数量（实线）
   - 副Y轴：数量转化率（虚线）

3. **销售人员对比图表**
   - 数量对比图
   - 金额对比图
   - 转化率对比图

4. **客户类型分析图表**（新增）
   - 客户类型金额趋势图
   - 客户类型数量趋势图
   - 客户类型金额占比图
   - 客户类型数量占比图
   - 零售与批发金额分析图
   - 零售与批发数量分析图

**交互功能**：
- 按销售人员过滤
- 按客户类型和公司类型过滤
- 时间周期选择（月/周）
- 金额区间过滤（≤1000、1000-5000、5000-10000、≥10000、全部金额）
- 图表最大化显示
- 数据导出功能

---

## 数据结构设计

### 5.1 核心数据结构

#### 5.1.1 销售数据结构

```python
SalesRecord = {
    "订单编号": str,           # 订单编号
    "客户名称": str,           # 客户名称
    "客户/公司类型": str,      # 客户公司类型（公司/个人）
    "客户/类型": str,          # 客户类型（零售/批发/经销商等）
    "销售人员": str,           # 销售人员
    "订单状态": str,           # 订单状态
    "总计": float,            # 总计金额
    "订单金额": float,         # 转换后的订单金额
    "报价单金额": float,       # 转换后的报价单金额
    "订单数量": int,           # 转换后的订单数量
    "报价单数量": int,         # 转换后的报价单数量
    "日期": str               # 订单日期
}
```

#### 5.1.2 客户类型分析结构

```python
CustomerTypeAnalysis = {
    "客户类型": str,           # 客户类型
    "订单数量": int,           # 该客户类型的订单数量
    "报价单数量": int,         # 该客户类型的报价单数量
    "订单金额": float,         # 该客户类型的订单金额
    "报价单金额": float,       # 该客户类型的报价单金额
    "数量转化率": float,       # 数量转化率
    "金额转化率": float        # 金额转化率
}
```

---

## API设计

### 7.1 核心API接口

#### 7.1.1 客户类型分析API

```http
# 获取客户类型选项
GET /get_customer_type_options

Response:
{
  "success": true,
  "customer_types": ["零售", "批发", "经销商"],
  "company_types": ["公司", "个人"]
}

# 更新销售分析（支持客户类型过滤）
POST /update_sales_analysis
Content-Type: application/json
{
  "sales_person": "John",
  "start_date": "2024-01-01",
  "end_date": "2024-12-31",
  "amount_range": "all",
  "customer_company_type": "公司",
  "customer_types": ["零售", "批发"]
}
```

---

## 界面设计

### 8.1 销售分析页面设计

#### 8.1.1 数据汇总区域

**过滤条件**：
- 客户公司类型（单选下拉框）
- 客户类型（多选下拉框）
- 其他现有过滤条件

**分析表格**：
- 销售员业绩分析表
- 客户订单分析表
- 客户类型分析表（新增）

#### 8.1.2 统计图表区域

**现有图表**：
- 订单金额转化率分析
- 订单数量转化率分析
- 销售人员对比图表

**新增图表**：
- 客户类型金额趋势图
- 客户类型数量趋势图
- 客户类型金额占比图
- 客户类型数量占比图
- 零售与批发金额分析图
- 零售与批发数量分析图

---

## 部署说明

### 9.1 环境要求

#### 9.1.1 系统要求

| 组件 | 最低要求 | 推荐配置 |
|------|----------|----------|
| 操作系统 | Linux/Windows/macOS | Ubuntu 20.04+ |
| Python | 3.8+ | 3.10+ |
| 内存 | 512MB | 2GB+ |
| 存储 | 1GB | 10GB+ |
| 网络 | 10Mbps | 100Mbps+ |

#### 9.1.2 依赖包要求

```txt
Flask>=2.0.0
PyPDF2>=3.0.0
pandas>=1.5.0
reportlab>=3.6.0
gunicorn>=20.0.0
requests>=2.28.0
```

---

## 版本更新记录

### v3.1.0 (2024-12-19) - 客户类型分析功能

#### 新增功能
- **客户类型分析表**：按客户类型统计订单和报价单数据，计算转化率
- **客户类型过滤**：支持按客户公司类型（单选）和客户类型（多选）过滤
- **6个新增图表**：
  - 客户类型金额趋势图
  - 客户类型数量趋势图
  - 客户类型金额占比图
  - 客户类型数量占比图
  - 零售与批发金额分析图
  - 零售与批发数量分析图
- **数据预处理**：自动处理空值和NaN，转换为"未设置"
- **动态选项获取**：过滤条件选项从数据中动态获取

#### 技术改进
- 新增客户类型数据预处理函数
- 新增客户类型分析相关API
- 优化前端图表渲染逻辑
- 完善多语言翻译支持

#### 界面优化
- 更新帮助页面，添加客户类型分析功能说明
- 优化表格排序功能，支持客户类型分析表
- 改进图表放大功能，支持新增的6个图表

### 历史版本记录

| 版本 | 发布日期 | 主要更新 |
|------|---------|----------|
| v1.0.0 | 2024-01-01 | 初始版本发布 |
| v1.1.0 | 2024-02-01 | 新增多语言支持 |
| v1.2.0 | 2024-03-01 | 优化SKU映射功能 |
| v2.0.0 | 2024-07-27 | 重写SKU映射管理页面 |
| v2.5.0 | 2024-07-29 | 统一页面样式，简化系统功能 |
| v2.6.0 | 2024-07-29 | 修复PDF上传错误，重写SKU生成逻辑 |
| v2.7.0 | 2024-07-29 | 优化价格表导入后的自动刷新功能 |
| v3.0.0 | 2024-08-03 | 销售分析系统重大升级 |
| **v3.1.0** | **2024-12-19** | **客户类型分析功能** |

---

**文档版本**: v3.1.0  
**最后更新**: 2024-12-19  
**维护者**: OCCW系统开发团队
