[% extends "base.html" %]

[% block title %]SKU Mapping Management - OCCW Quotation System[% endblock %]

[% block content %]
<!-- Page Title -->
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="fas fa-exchange-alt me-3 page-icon"></i>
                    [[ t('sku_mapping_management') ]]
                </h1>
                <p class="page-subtitle">[[ t('sku_mapping_desc') ]]</p>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>[[ t('sku_mapping_management') ]]
                    </h4>
                </div>
                <div class="card-body">
                    
                    <!-- Operation Toolbar -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="[[ _("search") ]]Original SKU or Mapped SKU..." onkeypress="handleSearchKeyPress(event)">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchMappings()">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter" onchange="applyFilters()">
                                <option value="">All Status</option>
                                <option value="valid">Has Price</option>
                                <option value="invalid">No Price</option>
                            </select>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-primary" onclick="refreshMappings()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="addNewMapping()">
                                    <i class="fas fa-plus me-1"></i>Add New Mapping
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="exportMappings()">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="clearAllMappings()" id="clearAllBtn" style="display: none;">
                                    <i class="fas fa-trash me-1"></i>Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Information -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div id="statsInfo" class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <span>Loading mapping statistics...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SKU Mapping Table -->
                    <div id="mappingTableContainer">
                        <div id="mappingTableLoading" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading SKU mapping data...</p>
                        </div>
                        
                        <div id="mappingTableContent" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="25%">Original SKU</th>
                                            <th width="25%">Mapped SKU</th>
                                            <th width="15%">Price</th>
                                            <th width="15%">Status</th>
                                            <th width="15%">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mappingTableBody">
                                        <!-- Dynamic Content -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav>
                                <ul class="pagination justify-content-center" id="pagination">
                                    <!-- Dynamic Pagination -->
                                </ul>
                            </nav>
                        </div>
                        
                        <div id="mappingTableEmpty" class="text-center py-5" style="display: none;">
                            <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No SKU mapping data available</h5>
                            <p class="text-muted">Mapping relationships will be automatically generated after uploading PDF [[ _("quotation_order") ]]</p>
                            <a href="/" class="btn btn-primary">
                                <i class="fas fa-upload me-1"></i>Go to upload [[ _("quotation_order") ]]
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Mapping Modal -->
<div class="modal fade" id="editMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i><span id="modalTitle">Edit SKU Mapping</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMappingForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editOriginalSku" class="form-label">
                                    <i class="fas fa-tag me-1"></i>Original SKU
                                </label>
                                <input type="text" class="form-control" id="editOriginalSku" 
                                       placeholder="输入Original SKU">
                                <div class="form-text">SKU from PDF [[ _("quotation_order") ]]</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editMappedSku" class="form-label">
                                    <i class="fas fa-link me-1"></i>Mapped SKU
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="editMappedSku" 
                                           placeholder="输入或选择OCCW SKU">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                            data-bs-toggle="dropdown" id="skuDropdownBtn">
                                        <i class="fas fa-list"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="skuDropdownMenu" 
                                        style="max-height: 300px; overflow-y: auto;">
                                        <li><span class="dropdown-item-text text-muted">正在加载...</span></li>
                                    </ul>
                                </div>
                                <div class="form-text">对应的OCCW系统SKU</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-search me-1"></i>[[ _("sku_search_assistant") ]]
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="skuSearchInput" 
                                           placeholder="[[ _("search_occw_sku") ]]...">
                                    <button class="btn btn-outline-primary" type="button" onclick="searchOCCWSku()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div id="skuSearchResults" class="mt-2" style="display: none;">
                                    <!-- [[ _("search") ]]结果 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>[[ _("tip") ]]：</strong>您可以直接输入SKU，或使用下拉菜单选择，或使用[[ _("search") ]]助手快速查找匹配的SKU。
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-primary" onclick="saveMappingForm()">
                    <i class="fas fa-save me-1"></i>保存映射
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 确认删除模态框 -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>确认删除
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-warning me-2"></i>
                    <strong>警告：</strong>确定要删除以下SKU映射关系吗？
                </div>
                <div class="row">
                    <div class="col-6">
                        <strong>Original SKU:</strong><br>
                        <code id="deleteOriginalSku" class="text-primary"></code>
                    </div>
                    <div class="col-6">
                        <strong>Mapped SKU:</strong><br>
                        <code id="deleteMappedSku" class="text-success"></code>
                    </div>
                </div>
                <p class="text-muted mt-3">此Actions不可撤销，但您可以重新创建映射关系。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteMapping()">
                    <i class="fas fa-trash me-1"></i>确认删除
                </button>
            </div>
        </div>
    </div>
</div>

[% endblock %]

[% block extra_js %]
<script>
// 全局变量
let currentPage = 1;
let currentSearch = '';
let totalPages = 1;
let allMappings = {};
let occwSkuList = [];
let currentEditingSku = '';

$(document).ready(function() {
    // console.log('SKU映射管理页面初始化...');
    
    // Initialize页面
    loadMappingData();
    loadOCCWSkuList();
    
    // 绑定事件
    $('#skuSearchInput').on('input', function() {
        debounceSearchOCCWSku();
    });
    
    // 绑定SKU输入框事件
    $('#editMappedSku').on('input', function() {
        const value = $(this).val();
        if (value.length > 2) {
            filterSkuDropdown(value);
        }
    });
    
    // 绑定实时[[ _("search") ]]
    $('#searchInput').on('input', function() {
        debounceSearch();
    });
});

// 防抖[[ _("search") ]]
let searchTimeout;
let mainSearchTimeout;

function debounceSearchOCCWSku() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(searchOCCWSku, 300);
}

function debounceSearch() {
    clearTimeout(mainSearchTimeout);
    mainSearchTimeout = setTimeout(applyFilters, 500);
}

// === 数据加载相关 ===
function loadMappingData(page = 1, search = '') {
    currentPage = page;
    currentSearch = search;
    
    $('#mappingTableLoading').show();
    $('#mappingTableContent').hide();
    $('#mappingTableEmpty').hide();
    
    $.ajax({
        url: '/get_sku_mappings',
        type: 'GET',
        success: function(response) {
            $('#mappingTableLoading').hide();
            
            if (response.success) {
                allMappings = response.mappings || {};
                
                if (Object.keys(allMappings).length > 0) {
                    displayMappings(allMappings, search);
                    $('#mappingTableContent').show();
                    $('#clearAllBtn').show();
                } else {
                    $('#mappingTableEmpty').show();
                    $('#clearAllBtn').hide();
                }
                
                updateStats(allMappings);
            } else {
                showAlert('[[ _("load_mapping_data_failed") ]]: ' + (response.error || '[[ _("unknown_error") ]]'), 'danger');
                $('#mappingTableEmpty').show();
            }
        },
        error: function(xhr) {
            $('#mappingTableLoading').hide();
            if (xhr.status === 401) {
                window.location.href = '/admin_login';
            } else {
                showAlert('[[ _("load_mapping_data_failed") ]]', 'danger');
                $('#mappingTableEmpty').show();
            }
        }
    });
}

function loadOCCWSkuList() {
    $.ajax({
        url: '/get_occw_skus',
        type: 'GET',
        success: function(response) {
            if (response.success && response.skus) {
                occwSkuList = response.skus;
                populateSkuDropdown();
            }
        },
        error: function() {
            console.error('加载OCCW SKU列表失败');
        }
    });
}

// 全局变量存储PriceStatus
let priceStatuses = {};

// === 界面显示相关 ===
function displayMappings(mappings, search = '', statusFilter = '') {
    const tbody = $('#mappingTableBody');
    tbody.empty();
    
    // 过滤数据
    let filteredMappings = Object.entries(mappings);
    
    // 分页
    const perPage = 20;
    const total = filteredMappings.length;
    const startIndex = (currentPage - 1) * perPage;
    const endIndex = startIndex + perPage;
    const paginatedMappings = filteredMappings.slice(startIndex, endIndex);
    
    // Show data
    paginatedMappings.forEach(([originalSku, mappedSku], index) => {
        const rowIndex = startIndex + index + 1;
        const row = createMappingRow(rowIndex, originalSku, mappedSku);
        tbody.append(row);
        
        // 异步加载Price
        loadPriceForMapping(rowIndex, mappedSku, statusFilter);
    });
    
    // Update pagination
    updatePagination(total, perPage);
    
    // 更新统计
    updateTableStats(startIndex + 1, Math.min(endIndex, total), total);
}

function createMappingRow(index, originalSku, mappedSku) {
    return `
        <tr id="mapping-row-${index}">
            <td>${index}</td>
            <td>
                <code class="text-primary">${originalSku}</code>
            </td>
            <td>
                <code class="text-success">${mappedSku}</code>
            </td>
            <td id="price-${index}">
                <div class="spinner-border spinner-border-sm text-muted" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </td>
            <td id="status-${index}">
                <span class="badge bg-secondary">检查中</span>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editMapping('${originalSku}', '${mappedSku}')" 
                            title="编辑映射">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteMapping('${originalSku}', '${mappedSku}')" 
                            title="删除映射">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
}

function loadPriceForMapping(rowIndex, mappedSku, statusFilter = '') {
    $.ajax({
        url: '/get_occw_price',
        type: 'GET',
        data: { sku: mappedSku },
        success: function(response) {
            const priceCell = $(`#price-${rowIndex}`);
            const statusCell = $(`#status-${rowIndex}`);
            const row = $(`#mapping-row-${rowIndex}`);
            
            let isValid = false;
            
            if (response.success && response.price > 0) {
                priceCell.html(`<strong class="text-success">$${response.price.toFixed(2)}</strong>`);
                statusCell.html(`<span class="badge bg-success">有效</span>`);
                isValid = true;
            } else {
                priceCell.html(`<span class="text-muted">No Price</span>`);
                statusCell.html(`<span class="badge bg-warning">No Price</span>`);
                isValid = false;
            }
            
            // 存储PriceStatus
            priceStatuses[mappedSku] = isValid;
            
            // 应用Status筛选
            if (statusFilter) {
                if ((statusFilter === 'valid' && !isValid) || 
                    (statusFilter === 'invalid' && isValid)) {
                    row.hide();
                } else {
                    row.show();
                }
            }
        },
        error: function() {
            const priceCell = $(`#price-${rowIndex}`);
            const statusCell = $(`#status-${rowIndex}`);
            const row = $(`#mapping-row-${rowIndex}`);
            
            priceCell.html(`<span class="text-danger">获取失败</span>`);
            statusCell.html(`<span class="badge bg-danger">错误</span>`);
            
            // 存储PriceStatus（错误也算无效）
            priceStatuses[mappedSku] = false;
            
            // 应用Status筛选
            if (statusFilter === 'valid') {
                row.hide();
            }
        }
    });
}

function updateStats(mappings) {
    const total = Object.keys(mappings).length;
    $('#statsInfo').html(`
        <i class="fas fa-info-circle me-1"></i>
        共有 <strong>${total}</strong> 个SKU映射关系
    `);
}

function updateTableStats(start, end, total) {
    if (total === 0) return;
    
    $('#statsInfo').html(`
        <i class="fas fa-info-circle me-1"></i>
        [[ _("showing_records") ]]`.replace('{start}', start).replace('{end}', end).replace('{total}', total)
    `);
}

function updatePagination(total, perPage) {
    const pagination = $('#pagination');
    pagination.empty();
    
    totalPages = Math.ceil(total / perPage);
    if (totalPages <= 1) return;
    
    // Previous page
    pagination.append(`
        <li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">[[ _("previous_page") ]]</a>
        </li>
    `);
    
    // Page number
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        pagination.append(`
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `);
    }
    
    // Next page
    pagination.append(`
        <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">[[ _("next_page") ]]</a>
        </li>
    `);
}

// === Actions相关 ===
function changePage(page) {
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        applyFilters();
    }
}

function refreshMappings() {
    loadMappingData(currentPage, currentSearch);
}

function searchMappings() {
    currentPage = 1;
    applyFilters();
}

function clearSearch() {
    $('#searchInput').val('');
    $('#statusFilter').val('');
    currentPage = 1;
    displayMappings(allMappings, '');
}

function applyFilters() {
    const search = $('#searchInput').val().trim();
    const statusFilter = $('#statusFilter').val();
    currentPage = 1;
    
    // 应用[[ _("search") ]]和Status筛选
    let filteredMappings = Object.entries(allMappings);
    
    // 文本[[ _("search") ]]
    if (search) {
        const searchLower = search.toLowerCase();
        filteredMappings = filteredMappings.filter(([originalSku, mappedSku]) => {
            return originalSku.toLowerCase().includes(searchLower) ||
                   mappedSku.toLowerCase().includes(searchLower);
        });
    }
    
    // 将过滤后的结果转换回对象格式
    const filteredObj = {};
    filteredMappings.forEach(([key, value]) => {
        filteredObj[key] = value;
    });
    
    displayMappings(filteredObj, '', statusFilter);
}

function handleSearchKeyPress(event) {
    if (event.key === 'Enter') {
        searchMappings();
    }
}

// === 映射编辑相关 ===
function addNewMapping() {
    currentEditingSku = '';
    $('#modalTitle').text('新增SKU映射');
    $('#editOriginalSku').val('').prop('readonly', false);
    $('#editMappedSku').val('');
    $('#skuSearchResults').hide();
    $('#editMappingModal').modal('show');
}

function editMapping(originalSku, mappedSku) {
    currentEditingSku = originalSku;
    $('#modalTitle').text('Edit SKU Mapping');
    $('#editOriginalSku').val(originalSku).prop('readonly', true);
    $('#editMappedSku').val(mappedSku);
    $('#skuSearchResults').hide();
    $('#editMappingModal').modal('show');
}

function saveMappingForm() {
    const originalSku = $('#editOriginalSku').val().trim();
    const mappedSku = $('#editMappedSku').val().trim();
    
    if (!originalSku) {
        showAlert('请输入Original SKU', 'warning');
        return;
    }
    
    if (!mappedSku) {
        showAlert('请输入或选择Mapped SKU', 'warning');
        return;
    }
    
    // 保存映射
    $.ajax({
        url: '/save_sku_mapping',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            original_sku: originalSku,
            mapped_sku: mappedSku
        }),
        success: function(response) {
            if (response.success) {
                $('#editMappingModal').modal('hide');
                showAlert('[[ _("sku_mapping_save_success") ]]', 'success');
                loadMappingData(currentPage, currentSearch);
            } else {
                showAlert(response.error || '[[ _("save_failed") ]]', 'danger');
            }
        },
        error: function(xhr) {
            if (xhr.status === 401) {
                window.location.href = '/admin_login';
            } else {
                showAlert('[[ _("save_sku_mapping_failed") ]]', 'danger');
            }
        }
    });
}

function deleteMapping(originalSku, mappedSku) {
    currentEditingSku = originalSku;
    $('#deleteOriginalSku').text(originalSku);
    $('#deleteMappedSku').text(mappedSku);
    $('#confirmDeleteModal').modal('show');
}

function confirmDeleteMapping() {
    $.ajax({
        url: '/delete_sku_mapping',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            original_sku: currentEditingSku
        }),
        success: function(response) {
            if (response.success) {
                $('#confirmDeleteModal').modal('hide');
                showAlert('[[ _("sku_mapping_delete_success") ]]', 'success');
                loadMappingData(currentPage, currentSearch);
            } else {
                showAlert(response.error || '[[ _("delete_failed") ]]', 'danger');
            }
        },
        error: function() {
            showAlert('[[ _("delete_sku_mapping_failed") ]]', 'danger');
        }
    });
}

function clearAllMappings() {
    if (!confirm('确定要清空所有SKU映射关系吗？\n\n此Actions不可撤销，但您可以重新上传PDF来生成新的映射关系。')) {
        return;
    }
    
    $.ajax({
        url: '/clear_all_sku_mappings',
        type: 'POST',
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                loadMappingData(1, ''); // 重新加载数据
            } else {
                showAlert(response.error || '[[ _("clear_failed") ]]', 'danger');
            }
        },
        error: function(xhr) {
            if (xhr.status === 401) {
                window.location.href = '/admin_login';
            } else {
                showAlert('[[ _("clear_sku_mapping_failed") ]]', 'danger');
            }
        }
    });
}

// === SKU[[ _("search") ]]助手 ===
function populateSkuDropdown() {
    const menu = $('#skuDropdownMenu');
    menu.empty();
    
    if (occwSkuList.length === 0) {
        menu.append('<li><span class="dropdown-item-text text-muted">暂无SKU数据</span></li>');
        return;
    }
    
    // 显示前50个SKU
    occwSkuList.slice(0, 50).forEach(sku => {
        menu.append(`
            <li><a class="dropdown-item" href="#" onclick="selectSku('${sku}')">${sku}</a></li>
        `);
    });
    
    if (occwSkuList.length > 50) {
        menu.append(`<li><hr class="dropdown-divider"></li>`);
        menu.append(`<li><span class="dropdown-item-text text-muted">显示前50个，使用[[ _("search") ]]查找更多</span></li>`);
    }
}

function filterSkuDropdown(query) {
    const menu = $('#skuDropdownMenu');
    menu.empty();
    
    const filtered = occwSkuList.filter(sku => 
        sku.toLowerCase().includes(query.toLowerCase())
    ).slice(0, 20);
    
    if (filtered.length === 0) {
        menu.append('<li><span class="dropdown-item-text text-muted">[[ _("no_matching_sku_found") ]]</span></li>');
        return;
    }
    
    filtered.forEach(sku => {
        const highlighted = sku.replace(
            new RegExp(query, 'gi'), 
            `<strong>$&</strong>`
        );
        menu.append(`
            <li><a class="dropdown-item" href="#" onclick="selectSku('${sku}')">${highlighted}</a></li>
        `);
    });
}

function selectSku(sku) {
    $('#editMappedSku').val(sku);
}

function searchOCCWSku() {
    const query = $('#skuSearchInput').val().trim();
    const resultsDiv = $('#skuSearchResults');
    
    if (query.length < 2) {
        resultsDiv.hide();
        return;
    }
    
    const matches = occwSkuList.filter(sku => 
        sku.toLowerCase().includes(query.toLowerCase())
    ).slice(0, 10);
    
    if (matches.length === 0) {
        resultsDiv.html('<div class="alert alert-info">[[ _("no_matching_sku_found") ]]</div>').show();
        return;
    }
    
    let html = '<div class="list-group">';
    matches.forEach(sku => {
        const highlighted = sku.replace(
            new RegExp(query, 'gi'), 
            `<strong class="text-primary">$&</strong>`
        );
        html += `
            <a href="#" class="list-group-item list-group-item-action" onclick="selectSearchResult('${sku}')">
                <code>${highlighted}</code>
            </a>
        `;
    });
    html += '</div>';
    
    resultsDiv.html(html).show();
}

function selectSearchResult(sku) {
    $('#editMappedSku').val(sku);
    $('#skuSearchResults').hide();
    $('#skuSearchInput').val('');
}

// === Export功能 ===
function exportMappings() {
    if (Object.keys(allMappings).length === 0) {
        showAlert('暂No Data可Export', 'warning');
        return;
    }
    
    $.ajax({
        url: '/export_sku_mappings',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                // 创建并下载JSON文件
                const dataStr = JSON.stringify(response, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `sku_mappings_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showAlert('[[ _("export_sku_mapping_success").format(count="${response.count}") ]]', 'success');
            } else {
                showAlert(response.error || '[[ _("export_failed") ]]', 'danger');
            }
        },
        error: function(xhr) {
            if (xhr.status === 401) {
                window.location.href = '/admin_login';
            } else {
                showAlert('[[ _("export_sku_mapping_failed") ]]', 'danger');
            }
        }
    });
}

// showAlert function has been unified in base.html as toast system
</script>
[% endblock %] 