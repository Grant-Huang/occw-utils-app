[% extends "base.html" %]

[% block title %]Imported Sales Data[% endblock %]

[% block content %]
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Page Title -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-table me-3 page-icon"></i>
                            Imported Sales Data
                        </h1>
                        <p class="page-subtitle">查看最近导入的[[ t("sales_order") ]] Data</p>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-secondary" onclick="window.close()">
                            <i class="fas fa-times me-1"></i>Close
                        </button>
                        <a href="/" class="btn btn-primary ms-2">
                            <i class="fas fa-home me-1"></i>Return to Home
                        </a>
                    </div>
                </div>
            </div>

            [% if error %]
            <!-- [[ t("error_message") ]] -->
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                [[ error ]]
            </div>
            [% elif data %]
            <!-- [[ t("current_filter_settings_tip") ]] -->
            [% if system_settings.get('import_filter_min_amount') or system_settings.get('import_filter_sales_person') or system_settings.get('import_filter_customer') or system_settings.get('import_filter_start_date') or system_settings.get('import_filter_end_date') or system_settings.get('import_filter_order_status') %]
            <div class="alert alert-warning" role="alert">
                <h6 class="alert-heading">
                    <i class="fas fa-filter me-2"></i>Currently applied import filter conditions
                </h6>
                <div class="row">
                    <div class="col-md-12">
                        <ul class="mb-2">
                            [% if system_settings.get('import_filter_min_amount') %]
                            <li><strong>[[ t("min_amount_threshold") ]]:</strong> ≥ $[[ system_settings.get('import_filter_min_amount') ]]</li>
                            [% endif %]
                            [% if system_settings.get('import_filter_sales_person') %]
                            <li><strong>Sales Person:</strong> [[ system_settings.get('import_filter_sales_person') ]]</li>
                            [% endif %]
                            [% if system_settings.get('import_filter_customer') %]
                            <li><strong>Customer:</strong> [[ system_settings.get('import_filter_customer') ]]</li>
                            [% endif %]
                            [% if system_settings.get('import_filter_start_date') %]
                            <li><strong>[[ t("start_date") ]]:</strong> [[ system_settings.get('import_filter_start_date') ]]</li>
                            [% endif %]
                            [% if system_settings.get('import_filter_end_date') %]
                            <li><strong>[[ t("end_date") ]]:</strong> [[ system_settings.get('import_filter_end_date') ]]</li>
                            [% endif %]
                            [% if system_settings.get('import_filter_order_status') %]
                            <li><strong>Order Status:</strong> [[ system_settings.get('import_filter_order_status') ]]</li>
                            [% endif %]
                        </ul>
                        <p class="mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            The displayed data has been filtered according to the above filter conditions. To modify filter settings, please go to
                            <a href="/admin" class="alert-link">Admin Dashboard → Order Import Filter Settings</a>
                        </p>
                    </div>
                </div>
            </div>
            [% endif %]
            
            <!-- Data Statistics Information -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Data Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-list-ol text-primary me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">Total Records</div>
                                    <div class="h4 mb-0 text-primary">[[ total_records ]]</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-users text-success me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">Sales Person Count</div>
                                    <div class="h4 mb-0 text-success">[[ data | map(attribute='Sales Person') | select | list | unique | list | length ]]</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-building text-warning me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">[[ t("customer_count") ]]</div>
                                    <div class="h4 mb-0 text-warning">[[ data | map(attribute='Customer') | select | list | unique | list | length ]]</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar text-info me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">[[ t("date_range") ]]</div>
                                    <div class="small text-muted">
                                        [% set valid_dates = [] %]
                                        [% for record in data %]
                                            [% if record['[[ t("order_date") ]]'] and record['[[ t("order_date") ]]'] != 'None' %]
                                                [% set _ = valid_dates.append(record['[[ t("order_date") ]]']) %]
                                            [% endif %]
                                        [% endfor %]
                                        [% if valid_dates %]
                                            [[ valid_dates | min ]] 至 [[ valid_dates | max ]]
                                        [% else %]
                                            No Data
                                        [% endif %]
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [[ t("data_filter_and_search") ]] -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">[[ t("data_filter") ]]</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">[[ t("search") ]]</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="[[ t("search_number_customer_salesperson") ]]" onkeyup="filterData()">
                        </div>
                        <div class="col-md-2">
                            <label for="salesPersonFilter" class="form-label">Sales Person</label>
                            <select class="form-control" id="salesPersonFilter" onchange="filterData()">
                                <option value="">All</option>
                                [% for person in data | map(attribute='Sales Person') | list | unique | sort %]
                                <option value="[[ person ]]">[[ person ]]</option>
                                [% endfor %]
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="statusFilter" class="form-label">Order Status</label>
                            <select class="form-control" id="statusFilter" onchange="filterData()">
                                <option value="">All</option>
                                [% for status in data | map(attribute='Order Status') | list | unique | sort %]
                                <option value="[[ status ]]">[[ status ]]</option>
                                [% endfor %]
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="startDate" class="form-label">[[ t("start_date") ]]</label>
                            <input type="date" class="form-control" id="startDate" onchange="filterData()">
                        </div>
                        <div class="col-md-2">
                            <label for="endDate" class="form-label">[[ t("end_date") ]]</label>
                            <input type="date" class="form-control" id="endDate" onchange="filterData()">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-secondary d-block" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Sales Data Details
                    </h5>
                    <div>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-1"></i>ExportExcel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="dataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 10%; cursor: pointer;" onclick="sortData('Number')">Number <i id="sort-Number" class="fas fa-sort"></i></th>
                                    <th style="width: 12%; cursor: pointer;" onclick="sortData('[[ t("order_date") ]]')">[[ t("order_date") ]] <i id="sort-[[ t("order_date") ]]" class="fas fa-sort"></i></th>
                                    <th style="width: 10%; cursor: pointer;" onclick="sortData('Sales Person')">Sales Person <i id="sort-Sales Person" class="fas fa-sort"></i></th>
                                    <th style="width: 15%; cursor: pointer;" onclick="sortData('Customer')">Customer <i id="sort-Customer" class="fas fa-sort"></i></th>
                                    <th style="width: 12%; cursor: pointer;" onclick="sortData('Total')">Total <i id="sort-Total" class="fas fa-sort"></i></th>
                                    <th style="width: 10%; cursor: pointer;" onclick="sortData('Gross Profit Margin (%)')">Gross Profit Margin (%) <i id="sort-Gross Profit Margin (%)" class="fas fa-sort"></i></th>
                                    <th style="width: 10%; cursor: pointer;" onclick="sortData('Order Status')">Order Status <i id="sort-Order Status" class="fas fa-sort"></i></th>
                                    <th style="width: 21%;">Other Information</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                [% for record in data %]
                                <tr data-record="[[ record | tojson | e ]]">
                                    <td>[[ record['Number'] ]]</td>
                                    <td>[[ record['[[ t("order_date") ]]'] ]]</td>
                                    <td>[[ record['Sales Person'] ]]</td>
                                    <td>[[ record['Customer'] ]]</td>
                                    <td class="text-end">
                                        [% if record['Total'] %]
                                        $[[ "%.2f" | format(record['Total']) ]]
                                        [% else %]
                                        -
                                        [% endif %]
                                    </td>
                                    <td class="text-end">
                                        [% if record['Gross Profit Margin (%)'] %]
                                        [[ "%.1f" | format(record['Gross Profit Margin (%)']) ]]%
                                        [% else %]
                                        -
                                        [% endif %]
                                    </td>
                                    <td>
                                        [% if record['Order Status'] == '[[ t("sales_order") ]]' %]
                                        <span class="badge bg-success">[[ record['Order Status'] ]]</span>
                                        [% elif record['Order Status'] == '[[ t("quotation_order") ]]' %]
                                        <span class="badge bg-warning">[[ record['Order Status'] ]]</span>
                                        [% else %]
                                        <span class="badge bg-secondary">[[ record['Order Status'] ]]</span>
                                        [% endif %]
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="showRecordDetails(this)">
                                            <i class="fas fa-eye me-1"></i>Details
                                        </button>
                                    </td>
                                </tr>
                                [% endfor %]
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="d-flex align-items-center">
                            <label for="pageSize" class="form-label me-2 mb-0">Items per page:</label>
                            <select class="form-select form-select-sm" id="pageSize" style="width: auto;" onchange="changePageSize()">
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">All</option>
                            </select>
                            <span class="ms-3 text-muted" id="pageInfo">[[ t("showing_records").format(start="1", end="25", total=total_records) ]]</span>
                        </div>
                        <nav aria-label="[[ t("data_pagination") ]]">
                            <ul class="pagination pagination-sm mb-0" id="pagination">
                                <!-- Pagination buttons will be dynamically generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
            [% endif %]
        </div>
    </div>
</div>

<!-- 记录Details模态框 -->
<div class="modal fade" id="recordDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">记录Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="recordDetailBody">
                <!-- Details内容将在这里动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">[[ t("close") ]]</button>
            </div>
        </div>
    </div>
</div>
[% endblock %]

[% block extra_js %]
<script>
let allRecords = [[ data | tojson if data else '[]' ]];
let filteredRecords = [...allRecords];
let currentPage = 1;
let pageSize = 25;

// [[ t("data_filter") ]]
function filterData() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const salesPersonFilter = document.getElementById('salesPersonFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    filteredRecords = allRecords.filter(record => {
        // [[ t("search") ]] filter
        const matchesSearch = !searchTerm || 
            (record['Number'] && record['Number'].toString().toLowerCase().includes(searchTerm)) ||
            (record['Customer'] && record['Customer'].toLowerCase().includes(searchTerm)) ||
            (record['Sales Person'] && record['Sales Person'].toLowerCase().includes(searchTerm));
        
        // Sales Person filter
        const matchesSalesPerson = !salesPersonFilter || record['Sales Person'] === salesPersonFilter;
        
        // [[ t("status_filter") ]]
        const matchesStatus = !statusFilter || record['Order Status'] === statusFilter;
        
        // [[ t("date_filter") ]]
        let matchesDate = true;
        if (startDate || endDate) {
            const orderDate = record['[[ t("order_date") ]]'];
            // 检查日期是否有效
            if (orderDate && orderDate !== 'None' && orderDate !== null) {
                const recordDate = new Date(orderDate);
                // 确保日期对象有效
                if (!isNaN(recordDate.getTime())) {
                    if (startDate && recordDate < new Date(startDate)) matchesDate = false;
                    if (endDate && recordDate > new Date(endDate)) matchesDate = false;
                } else {
                    // 无效日期，根据需要决定是否匹配
                    matchesDate = !startDate && !endDate;
                }
            } else {
                // 没有日期数据，根据需要决定是否匹配
                matchesDate = !startDate && !endDate;
            }
        }
        
        return matchesSearch && matchesSalesPerson && matchesStatus && matchesDate;
    });
    
    currentPage = 1;
    displayData();
}

// Clear filters
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('salesPersonFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    filterData();
}

// Change items per page
function changePageSize() {
    const newPageSize = document.getElementById('pageSize').value;
    pageSize = newPageSize === 'all' ? filteredRecords.length : parseInt(newPageSize);
    currentPage = 1;
    displayData();
}

// Show data
function displayData() {
    const tbody = document.getElementById('dataTableBody');
    if (!tbody) {
        // 如果表格不存在（比如显示错误页面时），直接返回
        return;
    }
    tbody.innerHTML = '';
    
    let startIndex = 0;
    let endIndex = filteredRecords.length;
    
    if (pageSize < filteredRecords.length) {
        startIndex = (currentPage - 1) * pageSize;
        endIndex = Math.min(startIndex + pageSize, filteredRecords.length);
    }
    
    const recordsToShow = filteredRecords.slice(startIndex, endIndex);
    
    recordsToShow.forEach(record => {
        const row = document.createElement('tr');
        row.setAttribute('data-record', JSON.stringify(record));
        
        const totalAmount = record['Total'] ? `$${parseFloat(record['Total']).toFixed(2)}` : '-';
        const profitMargin = record['Gross Profit Margin (%)'] ? `${parseFloat(record['Gross Profit Margin (%)']).toFixed(1)}%` : '-';
        
        let statusBadge = '';
        if (record['Order Status'] === '[[ t("sales_order") ]]') {
            statusBadge = '<span class="badge bg-success">[[ t("sales_order") ]]</span>';
        } else if (record['Order Status'] === '[[ t("quotation_order") ]]') {
            statusBadge = '<span class="badge bg-warning">[[ t("quotation_order") ]]</span>';
        } else {
            statusBadge = `<span class="badge bg-secondary">${record['Order Status']}</span>`;
        }
        
        row.innerHTML = `
            <td>${record['Number']}</td>
            <td>${record['[[ t("order_date") ]]']}</td>
            <td>${record['Sales Person']}</td>
            <td>${record['Customer']}</td>
            <td class="text-end">${totalAmount}</td>
            <td class="text-end">${profitMargin}</td>
            <td>${statusBadge}</td>
            <td>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="showRecordDetails(this)">
                    <i class="fas fa-eye me-1"></i>Details
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    updatePageInfo();
    updatePagination();
}

// Update page information
function updatePageInfo() {
    const totalRecords = filteredRecords.length;
    let startRecord = 1;
    let endRecord = totalRecords;
    
    if (pageSize < totalRecords) {
        startRecord = (currentPage - 1) * pageSize + 1;
        endRecord = Math.min(currentPage * pageSize, totalRecords);
    }
    
    document.getElementById('pageInfo').textContent = 
        `[[ t("showing_records") ]]`.replace('{start}', startRecord).replace('{end}', endRecord).replace('{total}', totalRecords);
}

// Update pagination
function updatePagination() {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (pageSize >= filteredRecords.length) {
        return; // 不需要分页
    }
    
    const totalPages = Math.ceil(filteredRecords.length / pageSize);
    
    // Previous page
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">[[ t("previous_page") ]]</a>`;
    pagination.appendChild(prevLi);
    
    // Page number
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Next page
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">[[ t("next_page") ]]</a>`;
    pagination.appendChild(nextLi);
}

// 改变页面
function changePage(page) {
    const totalPages = Math.ceil(filteredRecords.length / pageSize);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayData();
    }
}

// 显示记录Details
function showRecordDetails(button) {
    const row = button.closest('tr');
    const record = JSON.parse(row.getAttribute('data-record'));
    
    const detailBody = document.getElementById('recordDetailBody');
    detailBody.innerHTML = '';
    
    // 创建Details表格
    const table = document.createElement('table');
    table.className = 'table table-bordered';
    
    Object.keys(record).forEach(key => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="width: 30%; font-weight: bold; background-color: #f8f9fa;">${key}</td>
            <td>${record[key] || '-'}</td>
        `;
        table.appendChild(row);
    });
    
    detailBody.appendChild(table);
    
    // 显示模态框
    new bootstrap.Modal(document.getElementById('recordDetailModal')).show();
}

// Sorting functionality
let currentSortColumn = '';
let currentSortDirection = 'asc';

function sortData(column) {
    // 切换排序方向
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }
    
    // Update sort icons
    document.querySelectorAll('[id^="sort-"]').forEach(icon => {
        icon.className = 'fas fa-sort';
    });
    const sortIcon = document.getElementById(`sort-${column}`);
    if (sortIcon) {
        sortIcon.className = currentSortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
    
    // Sort data
    filteredRecords.sort((a, b) => {
        let valueA = a[column];
        let valueB = b[column];
        
        // Handle different data types
        if (column === 'Total' || column === 'Gross Profit Margin (%)') {
            valueA = parseFloat(valueA) || 0;
            valueB = parseFloat(valueB) || 0;
        } else if (column === '[[ t("order_date") ]]') {
            valueA = new Date(valueA || '1900-01-01');
            valueB = new Date(valueB || '1900-01-01');
        } else {
            valueA = (valueA || '').toString().toLowerCase();
            valueB = (valueB || '').toString().toLowerCase();
        }
        
        if (currentSortDirection === 'asc') {
            return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        } else {
            return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
        }
    });
    
    // 重新显示数据
    currentPage = 1;
    displayData();
}

// Export to Excel
function exportToExcel() {
    // 创建CSV内容
    const headers = ['Number', '[[ t("order_date") ]]', 'Sales Person', 'Customer', 'Total', 'Gross Profit Margin (%)', 'Order Status'];
    let csvContent = headers.join(',') + '\n';
    
    filteredRecords.forEach(record => {
        const row = headers.map(header => {
            let value = record[header] || '';
            // 处理包含逗号的值
            if (value && value.toString().includes(',')) {
                value = `"${value}"`;
            }
            return value;
        }).join(',');
        csvContent += row + '\n';
    });
    
    // Create and download file
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `销售数据_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 只有在有数据且表格存在时才初始化显示
    if (allRecords.length > 0 && document.getElementById('dataTableBody')) {
        displayData();
    }
});
</script>
[% endblock %]