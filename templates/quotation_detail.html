[% extends "base.html" %]

[% block title %][[ t('quotation_detail') ]][% endblock %]

[% block content %]
<!-- Page Title -->
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="fas fa-file-invoice-dollar me-3 page-icon"></i>
                    [[ t('quotation_detail') ]]
                </h1>
                <p class="page-subtitle">[[ t('quotation_detail_subtitle') ]]</p>
            </div>
                         <div class="col-md-4 text-end">
                 <a href="/" class="btn btn-outline-secondary">
                     <i class="fas fa-arrow-left me-1"></i>[[ t('back') ]]
                 </a>
             </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    [% if error %]
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>[[ error ]]
    </div>
    [% elif quotation %]
         <!-- Quotation Information -->
     <div class="row mb-4">
         <div class="col-md-12">
             <div class="card">
                 <div class="card-header">
                     <h5 class="card-title mb-0">
                         <i class="fas fa-info-circle me-2"></i>[[ t('quotation_info') ]]
                     </h5>
                 </div>
                 <div class="card-body">
                     <div class="row">
                         <div class="col-md-6">
                             <table class="table table-borderless">
                                 <tr>
                                     <td><strong>[[ t('quotation_id') ]]:</strong></td>
                                     <td><code>[[ quotation.quotation_id ]]</code></td>
                                 </tr>
                                 <tr>
                                     <td><strong>[[ t('title') ]]:</strong></td>
                                     <td>[[ quotation.title ]]</td>
                                 </tr>
                                 <tr>
                                     <td><strong>[[ t('order_date') ]]:</strong></td>
                                     <td>[[ quotation.data.order_date ]]</td>
                                 </tr>
                             </table>
                         </div>
                         <div class="col-md-6">
                             <table class="table table-borderless">
                                 <tr>
                                     <td><strong>[[ t('user') ]]:</strong></td>
                                     <td>[[ quotation.data.user ]]</td>
                                 </tr>
                                 <tr>
                                     <td><strong>[[ t('sales_person') ]]:</strong></td>
                                     <td>[[ quotation.data.sales_person ]]</td>
                                 </tr>
                                 <tr>
                                     <td><strong>[[ t('type') ]]:</strong></td>
                                     <td>
                                         [% if quotation.data.type == 'pdf' %]
                                         [[ t('pdf_import') ]]
                                         [% else %]
                                         [[ t('manual_create') ]]
                                         [% endif %]
                                     </td>
                                 </tr>
                             </table>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
          </div>
 
     <!-- Add New Product Area -->
     <div id="addProductSection" class="card mt-3">
         <div class="card-header bg-primary text-white">
             <h6 class="card-title mb-0">
                 <i class="fas fa-plus me-2"></i>[[ t('add_new_product') ]]
             </h6>
         </div>
         <div class="card-body">
                          <!-- Add Product Button -->
              <div class="mb-3">
                  <!-- Button has been removed -->
              </div>
             
             <div class="table-responsive">
                 <table class="table table-bordered table-hover" id="addProductTable">
                                          <thead>
                          <tr>
                              <th style="width: 15%;">[[ t('product_type') ]]</th>
                              <th style="width: 15%;">[[ t('product_name') ]]</th>
                              <th style="width: 12.5%;">[[ t('box_variant') ]]</th>
                              <th style="width: 12.5%;">[[ t('door_variant') ]]</th>
                              <th style="width: 25%;">[[ t('add_product') ]]</th>
                              <th style="width: 10%;">[[ t('unit_price') ]]</th>
                              <th style="width: 10%;">[[ t('quantity') ]]</th>
                          </tr>
                      </thead>
                     <tbody id="addProductTableBody">
                        <!-- 默认的第一行，始终可见 -->
                        <tr id="add-row-0">
                            <td>
                                <select class="form-select form-select-sm" onchange="onCategoryChange(0)" id="category-0">
                                    <option value="">[[ t("select_type") ]]</option>
                                </select>
                            </td>
                            <td>
                                <select class="form-select form-select-sm" onchange="onProductChange(0)" id="product-0" disabled>
                                    <option value="">[[ t("select_product") ]]</option>
                                </select>
                            </td>
                            <td>
                                <select class="form-select form-select-sm" onchange="onVariantChange(0)" id="box-variant-0" disabled>
                                    <option value="">[[ t("select_box_variant") ]]</option>
                                </select>
                            </td>
                            <td>
                                <select class="form-select form-select-sm" onchange="onVariantChange(0)" id="door-variant-0" disabled>
                                    <option value="">[[ t("select_door_variant") ]]</option>
                                </select>
                            </td>
                            <td>
                                <span id="sku-0" class="badge bg-secondary">[[ t("not_selected") ]]</span>
                            </td>
                            <td>
                                <span id="price-0">$0.00</span>
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm" value="1" min="1" id="qty-0">
                            </td>
                        </tr>
                     </tbody>
                 </table>
             </div>
             <div class="mt-3 text-end">
                 <button type="button" class="btn btn-success" onclick="addCurrentProduct()">
                     <i class="fas fa-plus me-1"></i>[[ t('add_product') ]]
                 </button>
             </div>
         </div>
     </div>
 
          <!-- Product List -->
      <div class="card mt-3">
          <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">
                  <i class="fas fa-list me-2"></i>[[ t('products') ]]
              </h5>
              <div class="d-flex gap-2">
                  <button type="button" class="btn btn-primary btn-sm" onclick="exportQuotation('[[ quotation.quotation_id ]]')">
                      <i class="fas fa-download me-1"></i>[[ t('export_quotation') ]]
                  </button>
                  <button type="button" class="btn btn-success btn-sm" onclick="saveChanges()">
                      <i class="fas fa-save me-1"></i>[[ t('save_changes') ]]
                  </button>
              </div>
          </div>
         <div class="card-body">
             [% if quotation.data.products %]
             <div class="table-responsive">
                                  <table class="table table-striped table-hover" id="productsTable">
                      <thead class="table-dark">
                          <tr>
                              <th style="width: 6%;">[[ t('sequence_number') ]]</th>
                              <th style="width: 36%;">[[ t('sku') ]]</th>
                              <th style="width: 10%;">[[ t('quantity') ]]</th>
                              <th style="width: 15%;">[[ t('unit_price') ]]</th>
                              <th style="width: 15%;">[[ t('total') ]]</th>
                              <th style="width: 9%;">[[ t('operation') ]]</th>
                          </tr>
                      </thead>
                     <tbody id="productsTableBody">
                                                  [% for product in quotation.data.products %]
                          <tr data-product-index="[[ loop.index0 ]]">
                              <td>[[ loop.index ]]</td>
                              <td><code>[[ product.sku ]]</code></td>
                              <td>
                                  <input type="number" class="form-control form-control-sm" value="[[ product.qty ]]" min="1" onchange="updateProductTotal(this)">
                              </td>
                              <td>$[[ "%.2f"|format(product.price|float) ]]</td>
                              <td class="product-total">$[[ "%.2f"|format(product.line_total|float) ]]</td>
                              <td>
                                  <button type="button" class="btn btn-sm btn-danger" onclick="removeProduct([[ loop.index0 ]])">
                                      <i class="fas fa-trash"></i>
                                  </button>
                              </td>
                          </tr>
                          [% endfor %]
                     </tbody>
                                          <tfoot class="table-info">
                          <tr>
                              <td colspan="4" class="text-end"><strong>[[ t('total') ]]：</strong></td>
                              <td>
                                  <strong id="grandTotal">
                                      $[[ "%.2f"|format(quotation.data.total_amount|float) ]]
                                  </strong>
                              </td>
                              <td></td>
                          </tr>
                      </tfoot>
                 </table>
             </div>
             [% else %]
             <div class="text-center py-5">
                 <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                 <h5 class="text-muted">[[ t('no_products') ]]</h5>
                 <p class="text-muted">[[ t('no_products_desc') ]]</p>
             </div>
             [% endif %]
         </div>
     </div>

    <!-- Export Information -->
    [% if quotation.data.export_date or quotation.data.export_username or quotation.data.export_sales_person %]
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-file-export me-2"></i>[[ t('export_info') ]]
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                [% if quotation.data.export_date %]
                <div class="col-md-4">
                    <strong>[[ t('export_date') ]]:</strong> [[ quotation.data.export_date ]]
                </div>
                [% endif %]
                [% if quotation.data.export_username %]
                <div class="col-md-4">
                    <strong>[[ t('export_username') ]]:</strong> [[ quotation.data.export_username ]]
                </div>
                [% endif %]
                [% if quotation.data.export_sales_person %]
                <div class="col-md-4">
                    <strong>[[ t('sales_person') ]]:</strong> [[ quotation.data.export_sales_person ]]
                </div>
                [% endif %]
            </div>
        </div>
    </div>
    [% endif %]
    [% endif %]
</div>

<!-- Toast Notification Container -->
<div id="toastContainer" class="toast-container"></div>
[% endblock %]

[% block extra_css %]
<style>
/* Toast Notification System Styles */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
}

.toast-message {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 10px;
    padding: 12px 16px;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateX(100%);
    animation: slideIn 0.3s ease forwards;
}

.toast-message.success {
    border-left: 4px solid #28a745;
    background-color: #f8fff9;
}

.toast-message.warning {
    border-left: 4px solid #ffc107;
    background-color: #fffdf8;
}

.toast-message.error {
    border-left: 4px solid #dc3545;
    background-color: #fff8f8;
}

.toast-message.info {
    border-left: 4px solid #17a2b8;
    background-color: #f8fdff;
}

.toast-message:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

@keyframes slideIn {
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOut {
    to {
        opacity: 0;
        transform: translateX(100%);
    }
}

.toast-message.removing {
    animation: slideOut 0.3s ease forwards;
}
</style>
[% endblock %]

[% block extra_js %]
<script src="/static/js/shared_product_functions.js"></script>
<script>
// Toast notification system
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast-message ${type}`;
    toast.textContent = message;
    
    // Click to close
    toast.addEventListener('click', function() {
        removeToast(toast);
    });
    
    container.appendChild(toast);
    
    // Auto close after 15 seconds
    setTimeout(() => {
        removeToast(toast);
    }, 15000);
}

function removeToast(toast) {
    if (toast && toast.parentNode) {
        toast.classList.add('removing');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }
}

function exportQuotation(quotationId) {
    if (confirm('[[ t("confirm_export_quotation") ]]')) {
        window.open(`/export_quotation/${quotationId}`, '_blank');
    }
}

 function editQuotation(quotationId) {
     // This function is no longer needed, kept to avoid errors
 }

// Add new product
let editProductCounter = 1;

 function addNewProduct() {
     // 使用共享的新增产品函数
     addNewProductShared('addProductSection', 'addProductTableBody', editProductCounter);
     editProductCounter++;
 }

function loadProductCategories(rowNum) {
    // 使用共享函数
    loadProductCategoriesShared(rowNum);
}

function onCategoryChange(rowNum) {
    // 使用共享函数
    onCategoryChangeShared(rowNum);
}

function loadProducts(rowNum, category) {
    // 使用通用函数加载产品列表
    loadProductsByCategoryUniversal(category, rowNum, {
        elementPrefix: '',
        setValues: false
    });
}

function onProductChange(rowNum) {
    // 使用共享函数
    onProductChangeShared(rowNum);
}


function searchSkuAndPrice(rowNum) {
    // 使用共享函数
    searchSkuAndPriceShared(rowNum);
}

function onVariantChange(rowNum) {
    // 使用共享函数
    onVariantChangeShared(rowNum);
}



function addCurrentProduct() {
    // 获取当前添加产品表格中的所有产品行
    const tbody = document.getElementById('addProductTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    if (rows.length === 0) {
        showToast('请先添加产品行', 'warning');
        return;
    }
    
    // 遍历所有行，添加有效的产品
    let addedCount = 0;
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const rowNum = row.id.replace('add-row-', '');
        
        const sku = document.getElementById(`sku-${rowNum}`).textContent;
        const price = document.getElementById(`price-${rowNum}`).textContent;
        
        // 检查产品信息是否完整
        if (sku !== '[[ t("not_selected") ]]' && sku !== '[[ t("not_found") ]]' && price !== '$0.00') {
            addToProductList(rowNum);
            addedCount++;
        }
    }
    
    if (addedCount === 0) {
        showToast('请先选择完整的产品信息', 'warning');
    } else {
        showToast(`成功添加 ${addedCount} 个产品`, 'success');
        // 清空所有行的选择，但保留第一行
        clearAllRows();
    }
}

function addToProductList(rowNum) {
    const sku = document.getElementById(`sku-${rowNum}`).textContent;
    const price = document.getElementById(`price-${rowNum}`).textContent;
    const qty = parseInt(document.getElementById(`qty-${rowNum}`).value) || 1;
    
    if (sku === '[[ t("not_selected") ]]' || sku === '[[ t("not_found") ]]' || price === '$0.00') {
        showToast('请先选择完整的产品信息', 'warning');
        return;
    }
    
    const currentRowCount = $('#productsTableBody tr').length;
    const newIndex = currentRowCount;
    
         const newRow = `
         <tr data-product-index="${newIndex}">
             <td>${newIndex + 1}</td>
             <td><code>${sku}</code></td>
             <td>
                 <input type="number" class="form-control form-control-sm" value="${qty}" min="1" onchange="updateProductTotal(this)">
             </td>
             <td>${price}</td>
             <td class="product-total">$${(parseFloat(price.replace('$', '')) * qty).toFixed(2)}</td>
             <td>
                 <button type="button" class="btn btn-sm btn-danger" onclick="removeProduct(${newIndex})">
                     <i class="fas fa-trash"></i>
                 </button>
             </td>
         </tr>
     `;
    
    $('#productsTableBody').append(newRow);
    
    // 清空当前行并重新加载产品类别
    clearCurrentEditRow(rowNum);
    
    // 更新Total
    updateGrandTotal();
    
    showToast('产品添加成功', 'success');
}

function clearCurrentEditRow(rowNum) {
    // 清空当前行并重新加载产品类别
    const row = document.getElementById(`add-row-${rowNum}`);
    if (row) {
        // 清空所有选择框和输入框
        document.getElementById(`category-${rowNum}`).innerHTML = '<option value="">[[ t("select_type") ]]</option>';
        document.getElementById(`product-${rowNum}`).innerHTML = '<option value="">[[ t("select_product") ]]</option>';
        document.getElementById(`product-${rowNum}`).disabled = true;
        document.getElementById(`box-variant-${rowNum}`).innerHTML = '<option value="">[[ t("select_box_variant") ]]</option>';
        document.getElementById(`box-variant-${rowNum}`).disabled = true;
        document.getElementById(`door-variant-${rowNum}`).innerHTML = '<option value="">[[ t("select_door_variant") ]]</option>';
        document.getElementById(`door-variant-${rowNum}`).disabled = true;
        document.getElementById(`sku-${rowNum}`).textContent = '[[ t("not_selected") ]]';
        document.getElementById(`sku-${rowNum}`).className = 'badge bg-secondary';
        document.getElementById(`price-${rowNum}`).textContent = '$0.00';
        document.getElementById(`qty-${rowNum}`).value = '1';
        
        // 重新加载产品类别
        loadProductCategories(rowNum);
    }
}

function removeEditProduct(rowNum) {
    const row = document.getElementById(`add-row-${rowNum}`);
    if (row) {
        row.remove();
    }
}

function updateEditTotal() {
    // 这里可以添加更新编辑区域Total的逻辑
}

 function clearEditProductList() {
     // 清空编辑产品列表
     if (confirm('确定要清空所有产品吗？')) {
         $('#addProductTableBody').empty();
         editProductCounter = 1;
         // 添加一个空行并加载产品类别
         addNewProduct();
         showToast('产品列表已清空', 'success');
     }
 }
 
 // 页面加载完成后初始化
 $(document).ready(function() {
     console.log('页面加载完成，开始初始化...');
     
     // 初始化第一行的产品类别
     loadProductCategories(0);
     
     // 重置计数器，因为已经有第一行了
     editProductCounter = 1;
     
     console.log('初始化完成');
 });

// 清空所有行的选择，但保留第一行
function clearAllRows() {
    const tbody = document.getElementById('addProductTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    // 保留第一行，删除其他行
    while (rows.length > 1) {
        tbody.removeChild(rows[1]);
    }
    
    // 重置第一行
    const firstRow = rows[0];
    if (firstRow) {
        document.getElementById('category-0').value = '';
        document.getElementById('product-0').innerHTML = '<option value="">[[ t("select_product") ]]</option>';
        document.getElementById('product-0').disabled = true;
        document.getElementById('box-variant-0').innerHTML = '<option value="">[[ t("select_box_variant") ]]</option>';
        document.getElementById('box-variant-0').disabled = true;
        document.getElementById('door-variant-0').innerHTML = '<option value="">[[ t("select_door_variant") ]]</option>';
        document.getElementById('door-variant-0').disabled = true;
        document.getElementById('sku-0').textContent = '[[ t("not_selected") ]]';
        document.getElementById('sku-0').className = 'badge bg-secondary';
        document.getElementById('price-0').textContent = '$0.00';
        document.getElementById('qty-0').value = '1';
    }
    
    // 重新加载产品类别
    loadProductCategories(0);
    
    // 重置计数器
    editProductCounter = 1;
}

// 取消编辑
function cancelEdit() {
    // This function is no longer needed, kept to avoid errors
}

// 更新产品小计
function updateProductTotal(input) {
    const row = $(input).closest('tr');
    const price = parseFloat(row.find('td:eq(3)').text().replace('$', ''));
    const qty = parseInt($(input).val()) || 0;
    const total = price * qty;
    
    row.find('.product-total').text('$' + total.toFixed(2));
    updateGrandTotal();
}

// 更新Total
function updateGrandTotal() {
    let grandTotal = 0;
    $('.product-total').each(function() {
        const total = parseFloat($(this).text().replace('$', '')) || 0;
        grandTotal += total;
    });
    
    $('#grandTotal').text('$' + grandTotal.toFixed(2));
}

// 删除产品
function removeProduct(productIndex) {
    if (confirm('[[ t("confirm_remove_product") ]]')) {
        $(`tr[data-product-index="${productIndex}"]`).remove();
        updateSequenceNumbers();
        updateGrandTotal();
        showToast('产品已删除', 'success');
    }
}

// 更新序号
function updateSequenceNumbers() {
    $('#productsTableBody tr').each(function(index) {
        $(this).find('td:first').text(index + 1);
    });
}

// 保存更改
function saveChanges() {
    const products = [];
    $('#productsTableBody tr').each(function() {
        const sku = $(this).find('td:eq(1) code').text();
        const qty = $(this).find('input[type="number"]').val();
        const price = parseFloat($(this).find('td:eq(3)').text().replace('$', ''));
        
        products.push({
            sku: sku,
            qty: qty,
            price: price
        });
    });
    
    const quotationData = {
        title: '[[ quotation.title ]]',
        data: {
            type: '[[ quotation.data.type ]]',
            order_date: '[[ quotation.data.order_date ]]',
            user: '[[ quotation.data.user ]]',
            sales_person: '[[ quotation.data.sales_person ]]',
            products: products
        }
    };
    
    $.ajax({
        url: `/update_quotation/[[ quotation.quotation_id ]]`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(quotationData),
        success: function(response) {
            if (response.success) {
                showToast(response.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showToast(response.error, 'error');
            }
        },
        error: function() {
            showToast('[[ t("save_changes_failed") ]]', 'error');
        }
    });
}

function deleteQuotation(quotationId) {
    if (confirm('[[ t("confirm_delete_quotation") ]]')) {
        $.ajax({
            url: `/delete_quotation/${quotationId}`,
            type: 'POST',
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    showToast(response.error, 'error');
                }
            },
            error: function() {
                showToast('[[ t("delete_quotation_failed") ]]', 'error');
            }
        });
    }
 }
 </script>
 [% endblock %] 