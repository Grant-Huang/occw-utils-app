{% extends "base.html" %}

{% block title %}{{ t('price_management_title') }} - {{ t('system_name') }}{% endblock %}

{% block content %}
<!-- 页面标题 -->
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="fas fa-database me-3 page-icon"></i>
                    {{ t('price_management_title') }}
                </h1>
                <p class="page-subtitle">{{ t('occw_price_table_management') }}</p>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-database me-2"></i>{{ t('occw_price_table_management') }}
                    </h4>
                </div>
                <div class="card-body">
                    
                    <!-- 导入说明 -->
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>{{ t('excel_format_requirements') }}
                        </h5>
                        <div class="row">
                            <div class="col-lg-8">
                                <p class="mb-2"><strong>{{ t('required_columns') }}：</strong></p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-3">
                                        <thead>
                                            <tr>
                                                <th width="20%">{{ t('column_name') }}</th>
                                                <th width="15%">{{ t('column_type') }}</th>
                                                <th width="65%">{{ t('column_description') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><code>{{ t('internal_reference') }}</code></td>
                                                <td>{{ t('text_type') }}</td>
                                                <td>{{ t('sku_identifier') }}</td>
                                            </tr>
                                            <tr>
                                                <td><code>{{ t('sales_price') }}</code></td>
                                                <td>{{ t('number_type') }}</td>
                                                <td>{{ t('product_price') }}</td>
                                            </tr>
                                            <tr>
                                                <td><code>{{ t('variant_value') }}</code></td>
                                                <td>{{ t('text_type') }}</td>
                                                <td>{{ t('variant_format') }}</td>
                                            </tr>
                                            <tr>
                                                <td><code>{{ t('name_col') }}</code></td>
                                                <td>{{ t('text_type') }}</td>
                                                <td>{{ t('product_name_desc') }}</td>
                                            </tr>
                                            <tr>
                                                <td><code>{{ t('product_category_col') }}</code></td>
                                                <td>{{ t('text_type') }}</td>
                                                <td>{{ t('product_category_desc') }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <p class="mb-2"><strong>{{ t('supported_categories') }}：</strong></p>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-1"></i>RTA Assm.组合件</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Door</li>
                                    <li><i class="fas fa-check text-success me-1"></i>BOX</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Ending Panel</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Molding</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Toe Kick</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Filler</li>
                                    <li><i class="fas fa-check text-success me-1"></i>{{ t('other_hardware') }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 文件上传区域 -->
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-upload me-2"></i>{{ t('price_table_import') }}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="uploadForm" enctype="multipart/form-data">
                                        <div class="mb-3">
                                            <label for="excelFile" class="form-label">{{ t('select_excel_file') }}</label>
                                            <input type="file" class="form-control" id="excelFile" name="file" 
                                                   accept=".xlsx,.xls" required>
                                            <div class="form-text">{{ t('support_xlsx_xls') }}</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">{{ t('import_mode') }}</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="import_mode" 
                                                       id="modeCreate" value="create" checked>
                                                <label class="form-check-label" for="modeCreate">
                                                    <strong class="text-danger">{{ t('create_mode') }}（推荐）</strong> - {{ t('create_mode_desc') }}
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="import_mode" 
                                                       id="modeAppend" value="append">
                                                <label class="form-check-label" for="modeAppend">
                                                    <strong class="text-warning">{{ t('append_mode') }}</strong> - {{ t('append_mode_desc') }}
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-purple btn-lg w-100" id="uploadBtn">
                                            <i class="fas fa-cloud-upload-alt me-2"></i>{{ t('upload_button') }}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <!-- 统计信息 -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-chart-bar me-2"></i>价格表统计
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="statsContent">
                                        <div class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                            <p class="mt-2 text-muted">正在加载统计信息...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 价格表显示 -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-table me-2"></i>当前价格表
                            </h5>
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshPriceTable()">
                                    <i class="fas fa-sync-alt me-1"></i>刷新
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="exportPriceTable()">
                                    <i class="fas fa-download me-1"></i>导出
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- 高级搜索面板 -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-search me-2"></i>查询过滤
                                        <button class="btn btn-sm btn-outline-primary float-end" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#advancedSearch" 
                                                aria-expanded="false" aria-controls="advancedSearch">
                                            <i class="fas fa-filter me-1"></i>高级过滤
                                        </button>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- 基础搜索 -->
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                                <input type="text" class="form-control" id="skuSearch" 
                                                       placeholder="按SKU搜索..." onkeypress="handleSearchKeyPress(event)">
                                                <button class="btn btn-purple" type="button" onclick="applyFilters()">
                                                    搜索
                                                </button>
                                                <button class="btn btn-outline-secondary" type="button" onclick="clearAllFilters()">
                                                    清空
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div id="tableStats" class="text-muted d-flex align-items-center">
                                                <i class="fas fa-info-circle me-1"></i>
                                                <span>准备显示价格表...</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 高级过滤选项 -->
                                    <div class="collapse" id="advancedSearch">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label for="doorVariantFilter" class="form-label">门板变体</label>
                                                <select class="form-select" id="doorVariantFilter">
                                                    <option value="">全部</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="boxVariantFilter" class="form-label">柜身变体</label>
                                                <select class="form-select" id="boxVariantFilter">
                                                    <option value="">全部</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="categoryFilter" class="form-label">产品类别</label>
                                                <select class="form-select" id="categoryFilter">
                                                    <option value="">全部</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <button class="btn btn-success me-2" onclick="applyFilters()">
                                                    <i class="fas fa-filter me-1"></i>应用过滤
                                                </button>
                                                <button class="btn btn-outline-secondary" onclick="clearAllFilters()">
                                                    <i class="fas fa-eraser me-1"></i>清空所有过滤
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 价格表内容 -->
                            <div id="priceTableContainer">
                                <div id="priceTableLoading" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <p class="mt-3 text-muted">正在加载价格表...</p>
                                </div>
                                
                                <div id="priceTableContent" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover table-sm">
                                            <thead>
                                                <tr>
                                                    <th width="5%">#</th>
                                                    <th width="20%">SKU</th>
                                                    <th width="25%">产品名称</th>
                                                    <th width="10%">门板变体</th>
                                                    <th width="10%">柜身变体</th>
                                                    <th width="15%">类别</th>
                                                    <th width="15%">价格</th>
                                                </tr>
                                            </thead>
                                            <tbody id="priceTableBody">
                                                <!-- 动态内容 -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- 分页 -->
                                    <nav>
                                        <ul class="pagination justify-content-center" id="pagination">
                                            <!-- 动态分页 -->
                                        </ul>
                                    </nav>
                                </div>
                                
                                <div id="priceTableEmpty" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">暂无价格数据</h5>
                                    <p class="text-muted">请上传Excel文件来导入价格表</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 错误详情模态框 -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>导入错误详情
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>错误总数：</strong><span id="errorCount">0</span> 个
                </div>
                <div class="list-group" id="errorList" style="max-height: 400px; overflow-y: auto;">
                    <!-- 错误详情 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let currentPage = 1;
let currentSearch = '';
let totalPages = 1;
let currentFilters = {
    sku: '',
    doorVariant: '',
    boxVariant: '',
    category: ''
};

$(document).ready(function() {
    console.log('OCCW价格表管理页面初始化...');
    
    // 初始化页面
    loadStats();
    loadFilterOptions();
    loadPriceTable(1);
    
    // 绑定上传表单事件
    $('#uploadForm').on('submit', handleUpload);
    
    // 绑定过滤器变化事件
    $('#doorVariantFilter, #boxVariantFilter, #categoryFilter').on('change', applyFilters);
});

// === 统计信息相关 ===
function loadStats() {
    $('#statsContent').html(`
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2 text-muted">正在加载统计信息...</p>
        </div>
    `);
    
    $.ajax({
        url: '/get_occw_stats',
        type: 'GET',
        success: function(response) {
            const count = response.count || 0;
            $('#statsContent').html(`
                <div class="row text-center">
                    <div class="col">
                        <h2 class="text-primary mb-1">${count.toLocaleString()}</h2>
                        <p class="text-muted mb-0">条价格记录</p>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6 text-center">
                        <small class="text-muted">最后更新</small><br>
                        <small>${new Date().toLocaleString()}</small>
                    </div>
                    <div class="col-6 text-center">
                        <small class="text-muted">文件格式</small><br>
                        <small>Excel (.xlsx/.xls)</small>
                    </div>
                </div>
            `);
        },
        error: function() {
            $('#statsContent').html(`
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>加载统计信息失败</p>
                </div>
            `);
        }
    });
}

// === 文件上传相关 ===
function handleUpload(e) {
    e.preventDefault();
    
    const fileInput = $('#excelFile')[0];
    if (!fileInput.files[0]) {
        showAlert('请选择Excel文件', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('import_mode', $('input[name="import_mode"]:checked').val());
    
    const uploadBtn = $('#uploadBtn');
    const originalText = uploadBtn.html();
    uploadBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>正在导入...').prop('disabled', true);
    
    $.ajax({
        url: '/upload_occw_prices',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                // 检查是否有错误
                if (response.has_errors && response.error_count > 0) {
                    // 部分成功：有些行成功，有些行失败
                    showAlert(response.message, 'warning');
                    showErrorDetails(response.error_details, 'partial_success');
                } else {
                    // 完全成功：所有行都成功
                    showAlert(response.message + ' - 价格表已自动刷新', 'success');
                }
                
                $('#excelFile').val('');
                // 刷新所有相关数据
                loadStats();
                loadFilterOptions();
                loadPriceTable(1);
            } else {
                handleUploadError(response);
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            if (response) {
                handleUploadError(response);
            } else {
                showAlert('上传失败，请重试', 'danger');
            }
        },
        complete: function() {
            uploadBtn.html(originalText).prop('disabled', false);
        }
    });
}

function handleUploadError(response) {
    if (response.has_errors && response.error_details) {
        showErrorDetails(response.error_details, 'failed');
        showAlert(`导入失败：发现 ${response.error_details.length} 个错误，请查看详情`, 'danger');
    } else {
        showAlert(response.error || '导入失败', 'danger');
    }
}

function showErrorDetails(errorDetails, type = 'failed') {
    // 设置模态框标题和样式
    const modalHeader = $('#errorModal .modal-header');
    const modalTitle = $('#errorModal .modal-title');
    
    if (type === 'partial_success') {
        modalHeader.removeClass('bg-danger').addClass('bg-warning');
        modalTitle.html('<i class="fas fa-exclamation-triangle me-2"></i>部分导入成功 - 错误详情');
    } else {
        modalHeader.removeClass('bg-warning').addClass('bg-danger');
        modalTitle.html('<i class="fas fa-exclamation-triangle me-2"></i>导入错误详情');
    }
    
    // 显示错误数量
    $('#errorCount').text(errorDetails.length);
    
    // 显示错误列表
    const errorList = $('#errorList');
    errorList.empty();
    
    const errorClass = type === 'partial_success' ? 'text-warning' : 'text-danger';
    
    errorDetails.forEach((error, index) => {
        errorList.append(`
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1 ${errorClass}">错误 ${index + 1}</h6>
                </div>
                <p class="mb-1">${error}</p>
            </div>
        `);
    });
    
    $('#errorModal').modal('show');
}

// === 过滤选项加载 ===
function loadFilterOptions() {
    $.ajax({
        url: '/get_price_filter_options',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                const data = response.data;
                
                // 填充门板变体选项
                const doorSelect = $('#doorVariantFilter');
                doorSelect.empty().append('<option value="">全部</option>');
                data.door_variants.forEach(variant => {
                    doorSelect.append(`<option value="${variant}">${variant}</option>`);
                });
                
                // 填充柜身变体选项
                const boxSelect = $('#boxVariantFilter');
                boxSelect.empty().append('<option value="">全部</option>');
                data.box_variants.forEach(variant => {
                    boxSelect.append(`<option value="${variant}">${variant}</option>`);
                });
                
                // 填充类别选项
                const categorySelect = $('#categoryFilter');
                categorySelect.empty().append('<option value="">全部</option>');
                data.categories.forEach(category => {
                    categorySelect.append(`<option value="${category}">${category}</option>`);
                });
            }
        },
        error: function() {
            console.error('加载过滤选项失败');
        }
    });
}

// === 价格表显示相关 ===
function loadPriceTable(page = 1, search = '') {
    currentPage = page;
    currentSearch = search;
    
    $('#priceTableLoading').show();
    $('#priceTableContent').hide();
    $('#priceTableEmpty').hide();
    
    // 构建请求参数
    const requestData = {
        page: page,
        per_page: 50
    };
    
    // 添加过滤条件
    if (currentFilters.sku) {
        requestData.search_sku = currentFilters.sku;
    }
    if (currentFilters.doorVariant) {
        requestData.door_variant = currentFilters.doorVariant;
    }
    if (currentFilters.boxVariant) {
        requestData.box_variant = currentFilters.boxVariant;
    }
    if (currentFilters.category) {
        requestData.category = currentFilters.category;
    }
    
    // 兼容老的搜索参数
    if (search) {
        requestData.search = search;
    }
    
    $.ajax({
        url: '/get_occw_price_table',
        type: 'GET',
        data: requestData,
        success: function(response) {
            $('#priceTableLoading').hide();
            
            if (response.success && response.data && response.data.length > 0) {
                displayPriceTable(response);
                $('#priceTableContent').show();
            } else {
                $('#priceTableEmpty').show();
            }
        },
        error: function(xhr) {
            $('#priceTableLoading').hide();
            if (xhr.status === 401) {
                window.location.href = '/admin_login';
            } else {
                showAlert('加载价格表失败', 'danger');
                $('#priceTableEmpty').show();
            }
        }
    });
}

function displayPriceTable(response) {
    const tbody = $('#priceTableBody');
    tbody.empty();
    
    const startIndex = (response.page - 1) * response.per_page;
    
    response.data.forEach((item, index) => {
        tbody.append(`
            <tr>
                <td>${startIndex + index + 1}</td>
                <td><code class="text-primary">${item.sku}</code></td>
                <td>${item.product_name || '<span class="text-muted">-</span>'}</td>
                <td class="text-center">${item.door_variant || '<span class="text-muted">-</span>'}</td>
                <td class="text-center">${item.box_variant || '<span class="text-muted">-</span>'}</td>
                <td><span class="badge bg-secondary">${item.category || '未分类'}</span></td>
                <td class="text-end"><strong class="text-success">$${item.price.toFixed(2)}</strong></td>
            </tr>
        `);
    });
    
    // 更新分页
    updatePagination(response);
    
    // 更新统计
    const start = startIndex + 1;
    const end = Math.min(startIndex + response.per_page, response.total);
    $('#tableStats').html(`
        <i class="fas fa-info-circle me-1"></i>
        显示第 ${start}-${end} 条，共 ${response.total.toLocaleString()} 条记录
    `);
}

function updatePagination(response) {
    const pagination = $('#pagination');
    pagination.empty();
    
    totalPages = response.total_pages;
    const currentPage = response.page;
    
    if (totalPages <= 1) return;
    
    // 上一页
    pagination.append(`
        <li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>
        </li>
    `);
    
    // 页码
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        pagination.append(`
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `);
    }
    
    // 下一页
    pagination.append(`
        <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>
        </li>
    `);
}

function changePage(page) {
    if (page >= 1 && page <= totalPages) {
        loadPriceTable(page);
    }
}

function refreshPriceTable() {
    loadPriceTable(currentPage);
}

// === 新的过滤功能 ===
function applyFilters() {
    // 更新当前过滤条件
    currentFilters.sku = $('#skuSearch').val().trim();
    currentFilters.doorVariant = $('#doorVariantFilter').val();
    currentFilters.boxVariant = $('#boxVariantFilter').val();
    currentFilters.category = $('#categoryFilter').val();
    
    // 重新加载价格表
    loadPriceTable(1);
}

function clearAllFilters() {
    // 清空所有过滤条件
    $('#skuSearch').val('');
    $('#doorVariantFilter').val('');
    $('#boxVariantFilter').val('');
    $('#categoryFilter').val('');
    
    // 重置过滤状态
    currentFilters = {
        sku: '',
        doorVariant: '',
        boxVariant: '',
        category: ''
    };
    
    // 重新加载价格表
    loadPriceTable(1);
}

function handleSearchKeyPress(event) {
    if (event.key === 'Enter') {
        applyFilters();
    }
}

// === 兼容性函数（保持向后兼容） ===
function searchPriceTable() {
    applyFilters();
}

function clearSearch() {
    clearAllFilters();
}

function exportPriceTable() {
    showAlert('导出功能开发中...', 'info');
}

// === 页面初始化 ===
$(document).ready(function() {
    // 页面加载时初始化数据
    loadStats();
    loadFilterOptions();
    loadPriceTable(1);
});

// === 通用函数 ===
function showAlert(message, type) {
    const alertClass = {
        'success': 'alert-success',
        'danger': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // 在页面顶部显示
    $('.container-fluid').prepend(alertHtml);
    
    // 5秒后自动关闭
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
}
</script>
{% endblock %} 