{% extends "base.html" %}

{% block title %}{{ t('admin_dashboard') }}{% endblock %}

{% block content %}
<!-- 页面标题 -->
<div class="admin-dashboard-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="admin-dashboard-title">
                    <i class="fas fa-tachometer-alt me-3 page-icon"></i>
                    {{ t('admin_dashboard') }}
                </h1>
                <p class="admin-dashboard-subtitle">{{ t('admin_dashboard_subtitle') }}</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/admin_logout" class="btn btn-outline-light">
                    <i class="fas fa-sign-out-alt me-1"></i>{{ t('nav_admin_logout') }}
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- 功能卡片 -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 admin-card" onclick="showAllQuotations()">
                <div class="card-body text-center">
                    <div class="admin-icon">
                        <i class="fas fa-list-alt"></i>
                    </div>
                    <h5 class="card-title">{{ t('all_quotations') }}</h5>
                    <p class="card-text">{{ t('all_quotations_desc') }}</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 admin-card" onclick="showSalesPersonSettings()">
                <div class="card-body text-center">
                    <div class="admin-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h5 class="card-title">{{ t('sales_person_settings') }}</h5>
                    <p class="card-text">{{ t('sales_person_settings_desc') }}</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 admin-card" onclick="showPriceManagement()">
                <div class="card-body text-center">
                    <div class="admin-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <h5 class="card-title">{{ t('price_management') }}</h5>
                    <p class="card-text">{{ t('price_management_desc') }}</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 admin-card" onclick="showSkuMappings()">
                <div class="card-body text-center">
                    <div class="admin-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <h5 class="card-title">{{ t('sku_mappings') }}</h5>
                    <p class="card-text">{{ t('sku_mappings_desc') }}</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 admin-card" onclick="showSystemSettings()">
                <div class="card-body text-center">
                    <div class="admin-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <h5 class="card-title">{{ t('system_settings') }}</h5>
                    <p class="card-text">{{ t('system_settings_desc') }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 功能内容区域 -->
    <div id="adminContent">
        <!-- 全部报价单 -->
        <div id="all-quotations-content" class="admin-content" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-alt me-2"></i>{{ t('all_quotations') }}
                    </h5>
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="showAdminDashboard()">
                        <i class="fas fa-arrow-left me-1"></i>{{ t('back_to_dashboard') }}
                    </button>
                </div>
                <div class="card-body">
                    <!-- 搜索和过滤区域 -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="quotationSearchInput" placeholder="{{ t('search_quotations') }}" onkeyup="filterQuotations()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="userFilterSelect" onchange="filterQuotations()">
                                <option value="">{{ t('all_users') }}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="dateFilterSelect" onchange="filterQuotations()">
                                <option value="">{{ t('all_dates') }}</option>
                                <option value="today">{{ t('today') }}</option>
                                <option value="week">{{ t('this_week') }}</option>
                                <option value="month">{{ t('this_month') }}</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>{{ t('clear_filters') }}
                            </button>
                        </div>
                    </div>
                    
                    <!-- 报价单表格 -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="allQuotationsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 12%;">{{ t('quotation_id') }}</th>
                                    <th style="width: 20%;">{{ t('quotation_title') }}</th>
                                    <th style="width: 12%;">{{ t('user') }}</th>
                                    <th style="width: 12%;">{{ t('order_date') }}</th>
                                    <th style="width: 12%;">{{ t('sales_person') }}</th>
                                    <th style="width: 32%; text-align: right;">{{ t('operation') }}</th>
                                </tr>
                            </thead>
                            <tbody id="allQuotationsTableBody">
                                <!-- 报价单数据将在这里动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted">
                            <span id="quotationCount">{{ t('total_quotations') }}: 0</span>
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm" id="quotationPagination">
                                <!-- 分页按钮将在这里动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 销售人员设置 -->
        <div id="sales-person-content" class="admin-content" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>{{ t('sales_person_settings') }}
                    </h5>
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="showAdminDashboard()">
                        <i class="fas fa-arrow-left me-1"></i>{{ t('back_to_dashboard') }}
                    </button>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>{{ t('add_sales_person') }}</h6>
                            <form id="addSalesPersonForm">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="salesPersonName" placeholder="{{ t('sales_person_name') }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="email" class="form-control" id="salesPersonEmail" placeholder="{{ t('sales_person_email') }}" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success btn-sm mt-2">
                                    <i class="fas fa-plus me-1"></i>{{ t('add') }}
                                </button>
                            </form>
                        </div>
                    </div>
                    <div id="salesPersonsList">
                        <!-- 销售人员列表将在这里动态加载 -->
                    </div>
                </div>
            </div>
        </div>
        

        
        <!-- SKU映射 -->
        <div id="sku-mappings-content" class="admin-content" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>{{ t('sku_mappings') }}
                    </h5>
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="showAdminDashboard()">
                        <i class="fas fa-arrow-left me-1"></i>{{ t('back_to_dashboard') }}
                    </button>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>{{ t('add_sku_mapping') }}</h6>
                            <form id="addSkuMappingForm">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="originalSku" placeholder="{{ t('original_sku') }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="mappedSku" placeholder="{{ t('mapped_sku') }}" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-info btn-sm mt-2">
                                    <i class="fas fa-plus me-1"></i>{{ t('add') }}
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearAllSkuMappings()">
                                <i class="fas fa-trash me-1"></i>{{ t('clear_all_mappings') }}
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm ms-2" onclick="exportSkuMappings()">
                                <i class="fas fa-download me-1"></i>{{ t('export_mappings') }}
                            </button>
                        </div>
                    </div>
                    <div id="skuMappingsList">
                        <!-- SKU映射列表将在这里动态加载 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 系统设置 -->
        <div id="system-settings-content" class="admin-content" style="display: none;">
            <div class="card system-settings-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>{{ t('system_settings') }}
                    </h5>
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="showAdminDashboard()">
                        <i class="fas fa-arrow-left me-1"></i>{{ t('back_to_dashboard') }}
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-toggle-on me-2"></i>{{ t('feature_controls') }}
                            </h6>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="userLoginEnabled" 
                                           {% if system_settings.get('user_login_enabled', True) %}checked{% endif %}>
                                    <label class="form-check-label" for="userLoginEnabled">
                                        <strong>{{ t('enable_user_login') }}</strong>
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        {{ t('user_login_description') }}
                                    </small>
                                </div>
                            </div>
                            <button type="button" class="btn btn-warning" onclick="saveSystemSettings()">
                                <i class="fas fa-save me-1"></i>{{ t('save_settings') }}
                            </button>
                            
                            <hr class="my-4">
                            
                            <h6 class="text-danger mb-3">
                                <i class="fas fa-shield-alt me-2"></i>{{ t('admin_password_settings') }}
                            </h6>
                            <form id="adminPasswordForm">
                                <div class="mb-3">
                                    <label for="currentAdminPassword" class="form-label">{{ t('current_admin_password') }}</label>
                                    <input type="password" class="form-control" id="currentAdminPassword" required>
                                    <div class="form-text">{{ t('current_password_required') }}</div>
                                </div>
                                <div class="mb-3">
                                    <label for="newAdminPassword" class="form-label">{{ t('new_admin_password') }}</label>
                                    <input type="password" class="form-control" id="newAdminPassword" required>
                                    <div class="form-text">{{ t('new_password_requirements') }}</div>
                                </div>
                                <div class="mb-3">
                                    <label for="confirmAdminPassword" class="form-label">{{ t('confirm_new_password') }}</label>
                                    <input type="password" class="form-control" id="confirmAdminPassword" required>
                                    <div class="form-text">{{ t('confirm_password_help') }}</div>
                                </div>
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-key me-1"></i>{{ t('change_admin_password') }}
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>{{ t('system_info') }}
                            </h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <p class="mb-2">
                                        <strong>{{ t('current_status') }}:</strong>
                                        <span id="userLoginStatus" class="badge {% if system_settings.get('user_login_enabled', True) %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if system_settings.get('user_login_enabled', True) %}{{ t('enabled') }}{% else %}{{ t('disabled') }}{% endif %}
                                        </span>
                                    </p>
                                    <p class="mb-2">
                                        <strong>{{ t('last_updated') }}:</strong>
                                        <span id="lastUpdated">{{ t('just_now') }}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 价格管理 -->
        <div id="price-management-content" class="admin-content" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-dollar-sign me-2"></i>{{ t('price_management') }}
                    </h5>
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="showAdminDashboard()">
                        <i class="fas fa-arrow-left me-1"></i>{{ t('back_to_dashboard') }}
                    </button>
                </div>
                <div class="card-body">
                    
                    <!-- 导入说明 -->
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>{{ t('excel_format_requirements') }}
                        </h5>
                        <div class="row">
                            <div class="col-lg-8">
                                <p class="mb-2"><strong>{{ t('required_columns') }}：</strong></p>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-3">
                                        <thead>
                                            <tr>
                                                <th width="20%">{{ t('column_name') }}</th>
                                                <th width="15%">{{ t('column_type') }}</th>
                                                <th width="65%">{{ t('column_description') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><code>{{ t('internal_reference') }}</code></td>
                                                <td>{{ t('text_type') }}</td>
                                                <td>{{ t('sku_identifier') }}</td>
                                            </tr>
                                            <tr>
                                                <td><code>{{ t('sales_price') }}</code></td>
                                                <td>{{ t('number_type') }}</td>
                                                <td>{{ t('product_price') }}</td>
                                            </tr>
                                            <tr>
                                                <td><code>{{ t('variant_value') }}</code></td>
                                                <td>{{ t('text_type') }}</td>
                                                <td>{{ t('variant_format') }}</td>
                                            </tr>
                                            <tr>
                                                <td><code>{{ t('name_col') }}</code></td>
                                                <td>{{ t('text_type') }}</td>
                                                <td>{{ t('product_name_desc') }}</td>
                                            </tr>
                                            <tr>
                                                <td><code>{{ t('product_category_col') }}</code></td>
                                                <td>{{ t('text_type') }}</td>
                                                <td>{{ t('product_category_desc') }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <p class="mb-2"><strong>{{ t('supported_categories') }}：</strong></p>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-1"></i>RTA Assm.组合件</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Door</li>
                                    <li><i class="fas fa-check text-success me-1"></i>BOX</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Ending Panel</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Molding</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Toe Kick</li>
                                    <li><i class="fas fa-check text-success me-1"></i>Filler</li>
                                    <li><i class="fas fa-check text-success me-1"></i>{{ t('other_hardware') }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 文件上传区域 -->
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-upload me-2"></i>{{ t('upload_occw_prices') }}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="uploadOccwPricesForm" enctype="multipart/form-data">
                                        <div class="mb-3">
                                            <label for="occwPricesFile" class="form-label">{{ t('select_excel_file') }}</label>
                                            <input type="file" class="form-control" id="occwPricesFile" name="file" accept=".xlsx,.xls" required>
                                            <div class="form-text">{{ t('excel_file_requirements') }}</div>
                                        </div>
                                        <button type="submit" class="btn btn-warning">
                                            <i class="fas fa-upload me-1"></i>{{ t('upload_prices') }}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-search me-2"></i>{{ t('price_statistics') }}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="priceStats">
                                        <p class="text-muted">{{ t('upload_file_to_see_stats') }}</p>
                                    </div>
                                    <button type="button" class="btn btn-info btn-sm" onclick="loadPriceStats()">
                                        <i class="fas fa-refresh me-1"></i>{{ t('refresh_stats') }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 价格表显示区域 -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-table me-2"></i>{{ t('occw_price_table') }}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3 price-filter-row">
                                        <div class="col-md-2">
                                            <input type="text" class="form-control" id="skuFilterInput" placeholder="{{ t('search_sku') }}" onkeyup="filterPrices()">
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-control" id="categoryFilterSelect" onchange="filterPrices()">
                                                <option value="">{{ t('all_categories') }}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-control" id="boxVariantFilterSelect" onchange="filterPrices()">
                                                <option value="">{{ t('all_box_variants') }}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-control" id="doorVariantFilterSelect" onchange="filterPrices()">
                                                <option value="">{{ t('all_door_variants') }}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-primary" onclick="clearPriceFilters()">
                                                <i class="fas fa-times me-1"></i>{{ t('clear_filters') }}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="occwPricesTable">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>{{ t('sku') }}</th>
                                                    <th>{{ t('product_name') }}</th>
                                                    <th>{{ t('category') }}</th>
                                                    <th>{{ t('box_variant') }}</th>
                                                    <th>{{ t('door_variant') }}</th>
                                                    <th>{{ t('price') }}</th>
                                                </tr>
                                            </thead>
                                            <tbody id="occwPricesTableBody">
                                                <!-- 价格数据将在这里动态加载 -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- 分页控件 -->
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center">
                                                <span class="me-2">{{ t('show') }}</span>
                                                <select class="form-select form-select-sm me-2" id="perPageSelect" style="width: auto;" onchange="changePerPage()">
                                                    <option value="25">25</option>
                                                    <option value="50" selected>50</option>
                                                    <option value="100">100</option>
                                                    <option value="200">200</option>
                                                </select>
                                                <span class="me-2">{{ t('entries') }}</span>
                                                <span id="priceTableInfo" class="text-muted"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <nav aria-label="价格表分页">
                                                <ul class="pagination pagination-sm justify-content-end mb-0" id="priceTablePagination">
                                                    <!-- 分页按钮将在这里动态生成 -->
                                                </ul>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* 管理员卡片样式 */
.admin-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.admin-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 30px rgba(113, 75, 103, 0.2);
    border-color: var(--primary-color);
    background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
}

.admin-icon {
    font-size: 3.5rem;
    color: var(--primary-color);
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
}

.admin-card:hover .admin-icon {
    transform: scale(1.1);
    color: var(--primary-dark);
}

.admin-content {
    animation: fadeInUp 0.6s ease-out;
}

/* 功能卡片网格 */
.admin-card .card-body {
    padding: 2.5rem 1.5rem;
    text-align: center;
}

.admin-card .card-title {
    color: var(--primary-color);
    font-weight: 700;
    margin-bottom: 1rem;
    font-size: 1.25rem;
}

.admin-card .card-text {
    color: var(--text-light);
    font-size: 0.95rem;
    line-height: 1.6;
}

/* 管理员仪表板特殊样式 */
.admin-dashboard-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    color: var(--white);
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 1rem;
    box-shadow: 0 8px 16px rgba(113, 75, 103, 0.3);
}

.admin-dashboard-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--white);
}

.admin-dashboard-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    color: var(--white);
}

/* 统计卡片样式 */
.stats-card {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    color: var(--white);
    border: none;
    border-radius: 1rem;
    box-shadow: 0 4px 12px rgba(113, 75, 103, 0.3);
    transition: all 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(113, 75, 103, 0.4);
}

.stats-card .card-body {
    padding: 1.5rem;
    text-align: center;
}

.stats-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--white);
}

.stats-label {
    font-size: 0.9rem;
    opacity: 0.9;
    color: var(--white);
}

/* 价格管理特殊样式 */
.price-filter-row {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.price-filter-row .form-control,
.price-filter-row .form-select {
    border-radius: 0.5rem;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.price-filter-row .form-control:focus,
.price-filter-row .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(113, 75, 103, 0.25);
}

/* 系统设置特殊样式 */
.system-settings-card {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 2px solid var(--primary-color);
    border-radius: 1rem;
    box-shadow: 0 4px 12px rgba(113, 75, 103, 0.15);
}

.system-settings-card .card-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    color: var(--white);
    border-radius: 0.75rem 0.75rem 0 0;
}

/* 表单开关样式 */
.form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.form-check-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(113, 75, 103, 0.25);
}

/* 响应式调整 */
@media (max-width: 768px) {
    .admin-card .card-body {
        padding: 1.5rem 1rem;
    }
    
    .admin-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    
    .admin-card .card-title {
        font-size: 1.1rem;
    }
    
    .stats-number {
        font-size: 2rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 页面初始化
$(document).ready(function() {
    // 页面初始化完成
});

// 显示管理员仪表板
function showAdminDashboard() {
    $('.admin-card').show();
    $('.admin-content').hide();
}

// 显示全部报价单
function showAllQuotations() {
    console.log('showAllQuotations called');
    $('.admin-card').hide();
    $('.admin-content').hide();
    $('#all-quotations-content').show();
    loadAllQuotations();
}

// 显示销售人员设置
function showSalesPersonSettings() {
    $('.admin-card').hide();
    $('.admin-content').hide();
    $('#sales-person-content').show();
    loadSalesPersons();
}

// 显示价格表管理
function showPriceManagement() {
    $('.admin-card').hide();
    $('.admin-content').hide();
    $('#price-management-content').show();
    loadPriceStats();
    loadOccwPrices(1); // 从第一页开始加载
}

// 显示SKU映射
function showSkuMappings() {
    $('.admin-card').hide();
    $('.admin-content').hide();
    $('#sku-mappings-content').show();
    loadSkuMappings();
}

// 显示系统设置
function showSystemSettings() {
    $('.admin-card').hide();
    $('.admin-content').hide();
    $('#system-settings-content').show();
}

// 保存系统设置
function saveSystemSettings() {
    const userLoginEnabled = $('#userLoginEnabled').is(':checked');
    
    $.ajax({
        url: '/update_system_settings',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            user_login_enabled: userLoginEnabled
        }),
        success: function(response) {
            if (response.success) {
                showAlert('{{ t("settings_saved_success") }}', 'success');
                updateSystemStatus(userLoginEnabled);
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function() {
            showAlert('{{ t("save_settings_failed") }}', 'danger');
        }
    });
}

// 更新系统状态显示
function updateSystemStatus(userLoginEnabled) {
    const statusElement = $('#userLoginStatus');
    const lastUpdatedElement = $('#lastUpdated');
    
    if (userLoginEnabled) {
        statusElement.removeClass('bg-danger').addClass('bg-success').text('{{ t("enabled") }}');
    } else {
        statusElement.removeClass('bg-success').addClass('bg-danger').text('{{ t("disabled") }}');
    }
    
    lastUpdatedElement.text(new Date().toLocaleString());
}

// 加载全部报价单
function loadAllQuotations() {
    $.ajax({
        url: '/get_all_quotations',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                displayAllQuotationsList(response.quotations);
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function() {
            showAlert('{{ t("load_all_quotations_failed") }}', 'danger');
        }
    });
}

// 全局变量存储所有报价单数据
let allQuotationsData = [];
let filteredQuotationsData = [];
let currentPage = 1;
const itemsPerPage = 20;

// 显示全部报价单列表
function displayAllQuotationsList(allQuotations) {
    // 转换数据格式为扁平化数组
    allQuotationsData = [];
    Object.keys(allQuotations).forEach(function(username) {
        const userQuotations = allQuotations[username];
        if (userQuotations.length > 0) {
            userQuotations.forEach(function(quotation) {
                allQuotationsData.push({
                    ...quotation,
                    username: username
                });
            });
        }
    });
    
    // 初始化过滤器和显示
    initializeFilters();
    filterQuotations();
}

// 初始化过滤器
function initializeFilters() {
    // 填充用户过滤器
    const users = [...new Set(allQuotationsData.map(q => q.username))];
    const userSelect = $('#userFilterSelect');
    userSelect.find('option:not(:first)').remove();
    users.forEach(user => {
        userSelect.append(`<option value="${user}">${user}</option>`);
    });
}

// 过滤报价单
function filterQuotations() {
    const searchTerm = $('#quotationSearchInput').val().toLowerCase();
    const userFilter = $('#userFilterSelect').val();
    const dateFilter = $('#dateFilterSelect').val();
    
    filteredQuotationsData = allQuotationsData.filter(quotation => {
        // 搜索过滤
        const matchesSearch = !searchTerm || 
            quotation.title.toLowerCase().includes(searchTerm) ||
            quotation.quotation_id.toLowerCase().includes(searchTerm) ||
            quotation.username.toLowerCase().includes(searchTerm) ||
            (quotation.data && quotation.data.sales_person && quotation.data.sales_person.toLowerCase().includes(searchTerm));
        
        // 用户过滤
        const matchesUser = !userFilter || quotation.username === userFilter;
        
        // 日期过滤
        let matchesDate = true;
        if (dateFilter && quotation.data && quotation.data.order_date) {
            const orderDate = new Date(quotation.data.order_date);
            const now = new Date();
            
            switch (dateFilter) {
                case 'today':
                    matchesDate = orderDate.toDateString() === now.toDateString();
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    matchesDate = orderDate >= weekAgo;
                    break;
                case 'month':
                    const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                    matchesDate = orderDate >= monthAgo;
                    break;
            }
        }
        
        return matchesSearch && matchesUser && matchesDate;
    });
    
    currentPage = 1;
    displayQuotationsTable();
}

// 清除过滤器
function clearFilters() {
    $('#quotationSearchInput').val('');
    $('#userFilterSelect').val('');
    $('#dateFilterSelect').val('');
    filterQuotations();
}

// 显示报价单表格
function displayQuotationsTable() {
    const tbody = $('#allQuotationsTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = filteredQuotationsData.slice(startIndex, endIndex);
    
    if (filteredQuotationsData.length === 0) {
        tbody.html(`
            <tr>
                <td colspan="6" class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                    <h5 class="text-muted">{{ t('no_quotations') }}</h5>
                    <p class="text-muted">{{ t('no_quotations_desc') }}</p>
                </td>
            </tr>
        `);
        $('#quotationCount').text('{{ t("total_quotations") }}: 0');
        $('#quotationPagination').empty();
        return;
    }
    
    let html = '';
    pageData.forEach(function(quotation) {
        const orderDate = quotation.data && quotation.data.order_date ? quotation.data.order_date : '-';
        const salesPerson = quotation.data && quotation.data.sales_person ? quotation.data.sales_person : '-';
        
        html += `
            <tr>
                <td><code>${quotation.quotation_id}</code></td>
                <td>${quotation.title}</td>
                <td>${quotation.username}</td>
                <td>${orderDate}</td>
                <td>${salesPerson}</td>
                <td style="text-align: right;">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewQuotationDetail('${quotation.quotation_id}')">
                        <i class="fas fa-eye me-1"></i>{{ t('view') }}
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="editQuotation('${quotation.quotation_id}')">
                        <i class="fas fa-edit me-1"></i>{{ t('edit') }}
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteQuotation('${quotation.quotation_id}')">
                        <i class="fas fa-trash me-1"></i>{{ t('delete') }}
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.html(html);
    
    // 更新计数和分页
    $('#quotationCount').text(`{{ t("total_quotations") }}: ${filteredQuotationsData.length}`);
    displayPagination();
}

// 查看报价单详情
function viewQuotationDetail(quotationId) {
    window.open(`/view_quotation/${quotationId}`, '_blank');
}

// 编辑报价单
function editQuotation(quotationId) {
    // 直接打开报价单详情页面
    window.open(`/view_quotation/${quotationId}`, '_blank');
}

// 删除报价单
function deleteQuotation(quotationId) {
    if (confirm('{{ t("confirm_delete_quotation") }}')) {
        $.ajax({
            url: `/delete_quotation/${quotationId}`,
            type: 'POST',
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    loadAllQuotations(); // 重新加载报价单列表
                } else {
                    showAlert(response.error, 'danger');
                }
            },
            error: function() {
                showAlert('{{ t("delete_quotation_failed") }}', 'danger');
            }
        });
    }
}

// 显示分页
function displayPagination() {
    const totalPages = Math.ceil(filteredQuotationsData.length / itemsPerPage);
    const pagination = $('#quotationPagination');
    
    if (totalPages <= 1) {
        pagination.empty();
        return;
    }
    
    let html = '';
    
    // 上一页
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;
    
    // 页码
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    // 下一页
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;
    
    pagination.html(html);
}

// 切换页面
function changePage(page) {
    const totalPages = Math.ceil(filteredQuotationsData.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayQuotationsTable();
    }
}

// 加载销售人员列表
function loadSalesPersons() {
    $.ajax({
        url: '/get_sales_persons',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                displaySalesPersonsList(response.sales_persons);
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function() {
            showAlert('{{ t("load_sales_persons_failed") }}', 'danger');
        }
    });
}

// 显示销售人员列表
function displaySalesPersonsList(salesPersons) {
    const container = $('#salesPersonsList');
    
    if (salesPersons.length === 0) {
        container.html(`
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">{{ t('no_sales_persons') }}</h5>
                <p class="text-muted">{{ t('no_sales_persons_desc') }}</p>
            </div>
        `);
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += '<thead><tr><th>{{ t("name") }}</th><th>{{ t("email") }}</th><th>{{ t("operation") }}</th></tr></thead><tbody>';
    
    salesPersons.forEach(function(person) {
        html += `
            <tr>
                <td>${person.name}</td>
                <td>${person.email}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteSalesPerson('${person.name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.html(html);
}

// 添加销售人员
$('#addSalesPersonForm').on('submit', function(e) {
    e.preventDefault();
    
    const name = $('#salesPersonName').val();
    const email = $('#salesPersonEmail').val();
    
    $.ajax({
        url: '/add_sales_person',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ name: name, email: email }),
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                $('#salesPersonName').val('');
                $('#salesPersonEmail').val('');
                loadSalesPersons();
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function() {
            showAlert('{{ t("add_sales_person_failed") }}', 'danger');
        }
    });
});

// 删除销售人员
function deleteSalesPerson(name) {
    if (confirm('{{ t("confirm_delete_sales_person") }}')) {
        $.ajax({
            url: '/delete_sales_person',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: name }),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    loadSalesPersons();
                } else {
                    showAlert(response.error, 'danger');
                }
            },
            error: function() {
                showAlert('{{ t("delete_sales_person_failed") }}', 'danger');
            }
        });
    }
}





// 加载SKU映射
function loadSkuMappings() {
    $.ajax({
        url: '/get_sku_mappings',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                displaySkuMappingsList(response.mappings);
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function() {
            showAlert('{{ t("load_sku_mappings_failed") }}', 'danger');
        }
    });
}

// 显示SKU映射列表
function displaySkuMappingsList(mappings) {
    const container = $('#skuMappingsList');
    
    if (Object.keys(mappings).length === 0) {
        container.html(`
            <div class="text-center py-5">
                <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">{{ t('no_sku_mappings') }}</h5>
                <p class="text-muted">{{ t('no_sku_mappings_desc') }}</p>
            </div>
        `);
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += '<thead><tr><th>{{ t("original_sku") }}</th><th>{{ t("mapped_sku") }}</th><th>{{ t("operation") }}</th></tr></thead><tbody>';
    
    Object.keys(mappings).forEach(function(originalSku) {
        const mappedSku = mappings[originalSku];
        html += `
            <tr>
                <td><code>${originalSku}</code></td>
                <td><code class="text-primary">${mappedSku}</code></td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteSkuMapping('${originalSku}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.html(html);
}

// 添加SKU映射
$('#addSkuMappingForm').on('submit', function(e) {
    e.preventDefault();
    
    const originalSku = $('#originalSku').val();
    const mappedSku = $('#mappedSku').val();
    
    $.ajax({
        url: '/save_sku_mapping',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ original_sku: originalSku, mapped_sku: mappedSku }),
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                $('#originalSku').val('');
                $('#mappedSku').val('');
                loadSkuMappings();
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function() {
            showAlert('{{ t("add_sku_mapping_failed") }}', 'danger');
        }
    });
});

// 删除SKU映射
function deleteSkuMapping(originalSku) {
    if (confirm('{{ t("confirm_delete_sku_mapping") }}')) {
        $.ajax({
            url: '/delete_sku_mapping',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ original_sku: originalSku }),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    loadSkuMappings();
                } else {
                    showAlert(response.error, 'danger');
                }
            },
            error: function() {
                showAlert('{{ t("delete_sku_mapping_failed") }}', 'danger');
            }
        });
    }
}

// 清空所有SKU映射
function clearAllSkuMappings() {
    if (confirm('{{ t("confirm_clear_all_sku_mappings") }}')) {
        $.ajax({
            url: '/clear_all_sku_mappings',
            type: 'POST',
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    loadSkuMappings();
                } else {
                    showAlert(response.error, 'danger');
                }
            },
            error: function() {
                showAlert('{{ t("clear_sku_mappings_failed") }}', 'danger');
            }
        });
    }
}

// 导出SKU映射
function exportSkuMappings() {
    window.open('/export_sku_mappings', '_blank');
}

// 导出报价单
function exportQuotation(quotationId) {
    window.open(`/export_quotation/${quotationId}`, '_blank');
}

// 价格管理相关函数
$(document).ready(function() {
    // 价格上传表单提交处理
    $('#uploadOccwPricesForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        const fileInput = $('#occwPricesFile')[0];
        
        if (fileInput.files.length === 0) {
            showAlert('{{ t("please_select_file") }}', 'warning');
            return;
        }
        
        formData.append('file', fileInput.files[0]);
        
        $.ajax({
            url: '/upload_occw_prices',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    $('#occwPricesFile').val('');
                    loadPriceStats();
                    loadOccwPrices();
                } else {
                    showAlert(response.error, 'danger');
                }
            },
            error: function() {
                showAlert('{{ t("upload_failed") }}', 'danger');
            }
        });
    });
    
    // 管理员密码修改表单提交处理
    $('#adminPasswordForm').on('submit', function(e) {
        e.preventDefault();
        
        const currentPassword = $('#currentAdminPassword').val();
        const newPassword = $('#newAdminPassword').val();
        const confirmPassword = $('#confirmAdminPassword').val();
        
        // 验证输入
        if (!currentPassword || !newPassword || !confirmPassword) {
            showAlert('{{ t("all_fields_required") }}', 'warning');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showAlert('{{ t("passwords_not_match") }}', 'danger');
            return;
        }
        
        if (newPassword.length < 6) {
            showAlert('{{ t("password_too_short") }}', 'warning');
            return;
        }
        
        // 提交密码修改请求
        $.ajax({
            url: '/change_admin_password',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            }),
            success: function(response) {
                if (response.success) {
                    showAlert('{{ t("admin_password_changed_success") }}', 'success');
                    // 清空表单
                    $('#currentAdminPassword').val('');
                    $('#newAdminPassword').val('');
                    $('#confirmAdminPassword').val('');
                } else {
                    showAlert(response.error, 'danger');
                }
            },
            error: function() {
                showAlert('{{ t("change_admin_password_failed") }}', 'danger');
            }
        });
    });
});

// 加载价格统计
function loadPriceStats() {
    $.ajax({
        url: '/get_occw_stats',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                displayPriceStats(response.stats);
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function() {
            showAlert('{{ t("load_stats_failed") }}', 'danger');
        }
    });
}

// 显示价格统计
function displayPriceStats(stats) {
    const statsHtml = `
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-primary">${stats.total_products || 0}</h4>
                    <small class="text-muted">{{ t('total_products') }}</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-success">${stats.total_categories || 0}</h4>
                    <small class="text-muted">{{ t('total_categories') }}</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-info">$${stats.average_price || 0}</h4>
                    <small class="text-muted">{{ t('average_price') }}</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-warning">$${stats.total_value || 0}</h4>
                    <small class="text-muted">{{ t('total_value') }}</small>
                </div>
            </div>
        </div>
    `;
    $('#priceStats').html(statsHtml);
}

// 全局分页变量
let currentPage = 1;
let totalPages = 1;
let totalItems = 0;
let perPage = 50;

// 加载OCCW价格表
function loadOccwPrices(page = 1) {
    currentPage = page;
    perPage = parseInt($('#perPageSelect').val());
    
    $.ajax({
        url: '/get_occw_price_table',
        type: 'GET',
        data: {
            page: currentPage,
            per_page: perPage
        },
        success: function(response) {
            if (response.success) {
                displayOccwPrices(response.data || response.prices || []);
                initializePriceFilters(response.data || response.prices || []);
                
                // 更新分页信息
                totalPages = response.total_pages || 1;
                totalItems = response.total || 0;
                updatePaginationInfo();
                updatePaginationControls();
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function() {
            showAlert('{{ t("load_prices_failed") }}', 'danger');
        }
    });
}

// 显示OCCW价格表
function displayOccwPrices(prices) {
    const tbody = $('#occwPricesTableBody');
    tbody.empty();
    
    if (prices.length === 0) {
        tbody.html('<tr><td colspan="6" class="text-center text-muted">{{ t("no_prices_found") }}</td></tr>');
        return;
    }
    
    prices.forEach(function(price) {
        const row = `
            <tr>
                <td><code>${price.sku || ''}</code></td>
                <td>${price.product_name || ''}</td>
                <td><span class="badge bg-secondary">${price.category || ''}</span></td>
                <td>${price.box_variant || ''}</td>
                <td>${price.door_variant || ''}</td>
                <td><strong>$${price.price || 0}</strong></td>
            </tr>
        `;
        tbody.append(row);
    });
}

// 更新分页信息显示
function updatePaginationInfo() {
    const start = (currentPage - 1) * perPage + 1;
    const end = Math.min(currentPage * perPage, totalItems);
    const info = `显示第 ${start} 到 ${end} 条，共 ${totalItems} 条记录`;
    $('#priceTableInfo').text(info);
}

// 更新分页控件
function updatePaginationControls() {
    const pagination = $('#priceTablePagination');
    pagination.empty();
    
    if (totalPages <= 1) {
        return;
    }
    
    // 上一页按钮
    const prevBtn = $(`<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadOccwPricesWithFilters(${currentPage - 1})" ${currentPage === 1 ? 'tabindex="-1"' : ''}>
            <i class="fas fa-chevron-left"></i>
        </a>
    </li>`);
    pagination.append(prevBtn);
    
    // 页码按钮
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // 第一页
    if (startPage > 1) {
        pagination.append(`<li class="page-item"><a class="page-link" href="#" onclick="loadOccwPricesWithFilters(1)">1</a></li>`);
        if (startPage > 2) {
            pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
        }
    }
    
    // 中间页码
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = $(`<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadOccwPricesWithFilters(${i})">${i}</a>
        </li>`);
        pagination.append(pageBtn);
    }
    
    // 最后一页
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
        }
        pagination.append(`<li class="page-item"><a class="page-link" href="#" onclick="loadOccwPricesWithFilters(${totalPages})">${totalPages}</a></li>`);
    }
    
    // 下一页按钮
    const nextBtn = $(`<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadOccwPricesWithFilters(${currentPage + 1})" ${currentPage === totalPages ? 'tabindex="-1"' : ''}>
            <i class="fas fa-chevron-right"></i>
        </a>
    </li>`);
    pagination.append(nextBtn);
}

// 改变每页显示数量
function changePerPage() {
    loadOccwPricesWithFilters(1); // 重置到第一页
}

// 初始化价格过滤器
function initializePriceFilters(prices) {
    const categories = [...new Set(prices.map(p => p.category).filter(c => c))];
    const boxVariants = [...new Set(prices.map(p => p.box_variant).filter(v => v))];
    const doorVariants = [...new Set(prices.map(p => p.door_variant).filter(v => v))];
    
    const categorySelect = $('#categoryFilterSelect');
    const boxVariantSelect = $('#boxVariantFilterSelect');
    const doorVariantSelect = $('#doorVariantFilterSelect');
    
    categorySelect.find('option:not(:first)').remove();
    boxVariantSelect.find('option:not(:first)').remove();
    doorVariantSelect.find('option:not(:first)').remove();
    
    categories.forEach(category => {
        categorySelect.append(`<option value="${category}">${category}</option>`);
    });
    
    boxVariants.forEach(variant => {
        boxVariantSelect.append(`<option value="${variant}">${variant}</option>`);
    });
    
    doorVariants.forEach(variant => {
        doorVariantSelect.append(`<option value="${variant}">${variant}</option>`);
    });
}

// 过滤价格
function filterPrices() {
    // 重置到第一页
    currentPage = 1;
    loadOccwPricesWithFilters();
}

// 带过滤条件的加载价格表
function loadOccwPricesWithFilters(page = 1) {
    currentPage = page;
    perPage = parseInt($('#perPageSelect').val());
    
    const skuFilter = $('#skuFilterInput').val();
    const categoryFilter = $('#categoryFilterSelect').val();
    const boxVariantFilter = $('#boxVariantFilterSelect').val();
    const doorVariantFilter = $('#doorVariantFilterSelect').val();
    
    $.ajax({
        url: '/get_occw_price_table',
        type: 'GET',
        data: {
            page: currentPage,
            per_page: perPage,
            search_sku: skuFilter,
            category: categoryFilter,
            box_variant: boxVariantFilter,
            door_variant: doorVariantFilter
        },
        success: function(response) {
            if (response.success) {
                displayOccwPrices(response.data || response.prices || []);
                
                // 更新分页信息
                totalPages = response.total_pages || 1;
                totalItems = response.total || 0;
                updatePaginationInfo();
                updatePaginationControls();
            } else {
                showAlert(response.error, 'danger');
            }
        },
        error: function() {
            showAlert('{{ t("load_prices_failed") }}', 'danger');
        }
    });
}

// 清空价格过滤器
function clearPriceFilters() {
    $('#skuFilterInput').val('');
    $('#categoryFilterSelect').val('');
    $('#boxVariantFilterSelect').val('');
    $('#doorVariantFilterSelect').val('');
    filterPrices();
}

// 显示提示信息
function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('main').prepend(alertHtml);
    
    // 自动隐藏警告和成功消息
    if (type === 'warning' || type === 'success') {
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    }
}
</script>
{% endblock %} 