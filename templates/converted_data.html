{% extends "base.html" %}

{% block title %}转换后的销售数据{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- 页面标题 -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-table me-3 page-icon"></i>
                            转换后的销售数据
                        </h1>
                        <p class="page-subtitle">查看包含订单金额、{{ _("quotation_order") }}金额、转化率等字段的转换后数据</p>
                    </div>
                    <div>
                        <a href="/view_imported_data" class="btn btn-outline-secondary">
                            <i class="fas fa-eye me-1"></i>查看原始数据
                        </a>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="window.close()">
                            <i class="fas fa-times me-1"></i>关闭
                        </button>
                        <a href="/" class="btn btn-primary ms-2">
                            <i class="fas fa-home me-1"></i>返回主页
                        </a>
                    </div>
                </div>
            </div>

            {% if error %}
            <!-- {{ _("error_message") }} -->
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ error }}
            </div>
            {% elif data %}
            <!-- {{ _("current_filter_settings_tip") }} -->
            {% if system_settings.get('import_filter_min_amount') or system_settings.get('import_filter_sales_person') or system_settings.get('import_filter_customer') or system_settings.get('import_filter_start_date') or system_settings.get('import_filter_end_date') or system_settings.get('import_filter_order_status') %}
            <div class="alert alert-warning" role="alert">
                <h6 class="alert-heading">
                    <i class="fas fa-filter me-2"></i>当前应用的导入过滤条件
                </h6>
                <div class="row">
                    <div class="col-md-12">
                        <ul class="mb-2">
                            {% if system_settings.get('import_filter_min_amount') %}
                            <li><strong>{{ _("min_amount_threshold") }}:</strong> ≥ ${{ system_settings.get('import_filter_min_amount') }}</li>
                            {% endif %}
                            {% if system_settings.get('import_filter_sales_person') %}
                            <li><strong>销售人员:</strong> {{ system_settings.get('import_filter_sales_person') }}</li>
                            {% endif %}
                            {% if system_settings.get('import_filter_customer') %}
                            <li><strong>客户:</strong> {{ system_settings.get('import_filter_customer') }}</li>
                            {% endif %}
                            {% if system_settings.get('import_filter_start_date') %}
                            <li><strong>{{ _("start_date") }}:</strong> {{ system_settings.get('import_filter_start_date') }}</li>
                            {% endif %}
                            {% if system_settings.get('import_filter_end_date') %}
                            <li><strong>{{ _("end_date") }}:</strong> {{ system_settings.get('import_filter_end_date') }}</li>
                            {% endif %}
                            {% if system_settings.get('import_filter_order_status') %}
                            <li><strong>订单状态:</strong> {{ system_settings.get('import_filter_order_status') }}</li>
                            {% endif %}
                        </ul>
                        <p class="mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            显示的数据已根据上述过滤条件筛选。要修改过滤设定，请前往
                            <a href="/admin" class="alert-link">管理员仪表板 → 订单导入过滤设置</a>
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- 数据统计信息 -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>数据概览
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-list-ol text-primary me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">总记录数</div>
                                    <div class="h4 mb-0 text-primary">{{ total_records }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-shopping-cart text-success me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">{{ _("sales_order") }}数</div>
                                    <div class="h4 mb-0 text-success">{{ data | selectattr('订单状态', 'equalto', '{{ _("sales_order") }}') | list | length }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-invoice text-warning me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">{{ _("quotation_order") }}数</div>
                                    <div class="h4 mb-0 text-warning">{{ data | selectattr('订单状态', 'equalto', '{{ _("quotation_order") }}') | list | length }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-percentage text-info me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">整体转化率</div>
                                    <div class="h4 mb-0 text-info">
                                        {% set total_order_amount = data | map(attribute='订单金额') | select | list | sum %}
                                        {% set total_quotation_amount = data | map(attribute='{{ _("quotation_order") }}金额') | select | list | sum %}
                                        {% if total_quotation_amount > 0 %}
                                            {{ "%.1f" | format((total_order_amount / total_quotation_amount) * 100) }}%
                                        {% else %}
                                            0.0%
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 数据过滤和搜索 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">数据过滤</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">{{ _("search") }}</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="{{ _("search_number_customer_salesperson") }}" onkeyup="filterData()">
                        </div>
                        <div class="col-md-2">
                            <label for="salesPersonFilter" class="form-label">销售人员</label>
                            <select class="form-control" id="salesPersonFilter" onchange="filterData()">
                                <option value="">全部</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="statusFilter" class="form-label">订单状态</label>
                            <select class="form-control" id="statusFilter" onchange="filterData()">
                                <option value="">全部</option>
                                <!-- 状态选项将通过JavaScript从转换后数据动态生成 -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="startDate" class="form-label">{{ _("start_date") }}</label>
                            <input type="date" class="form-control" id="startDate" onchange="filterData()">
                        </div>
                        <div class="col-md-2">
                            <label for="endDate" class="form-label">{{ _("end_date") }}</label>
                            <input type="date" class="form-control" id="endDate" onchange="filterData()">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 数据表格 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>转换后数据列表
                        <span id="recordCount" class="badge bg-secondary ms-2">0</span>
                    </h5>
                    <div>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-1"></i>导出Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="dataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="cursor: pointer;" onclick="sortData('编号')">编号 <i id="sort-编号" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('{{ _("order_date") }}')">{{ _("order_date") }} <i id="sort-{{ _("order_date") }}" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('销售人员')">销售人员 <i id="sort-销售人员" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('客户')">客户 <i id="sort-客户" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('订单状态')">订单状态 <i id="sort-订单状态" class="fas fa-sort"></i></th>

                                    <th style="cursor: pointer;" onclick="sortData('订单金额')">订单金额 <i id="sort-订单金额" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('{{ _("quotation_order") }}金额')">{{ _("quotation_order") }}金额 <i id="sort-{{ _("quotation_order") }}金额" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('订单数量')">订单数量 <i id="sort-订单数量" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('{{ _("quotation_order") }}数量')">{{ _("quotation_order") }}数量 <i id="sort-{{ _("quotation_order") }}数量" class="fas fa-sort"></i></th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <!-- 数据将通过JavaScript填充 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="d-flex align-items-center">
                            <span class="me-2">每页显示:</span>
                            <select class="form-select form-select-sm" id="pageSize" style="width: auto;" onchange="changePageSize()">
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                        <div id="pageInfo" class="text-muted"></div>
                        <div id="pagination" class="d-flex gap-1"></div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- 无数据{{ _("tip") }} -->
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                暂无数据，请先导入销售数据。
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allRecords = {{ data | tojson if data else '[]' }};
let filteredRecords = [...allRecords];
let currentPage = 1;
let pageSize = 25;

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    // 填充销售人员过滤器
    const salesPersonSet = new Set();
    allRecords.forEach(record => {
        if (record['销售人员']) {
            salesPersonSet.add(record['销售人员']);
        }
    });
    
    const salesPersonFilter = document.getElementById('salesPersonFilter');
    Array.from(salesPersonSet).sort().forEach(person => {
        const option = document.createElement('option');
        option.value = person;
        option.textContent = person;
        salesPersonFilter.appendChild(option);
    });
    
    // 填充订单{{ _("status_filter") }}器 - 从转换后数据动态获取
    const statusSet = new Set();
    allRecords.forEach(record => {
        if (record['订单状态']) {
            statusSet.add(record['订单状态']);
        }
    });
    
    const statusFilter = document.getElementById('statusFilter');
    Array.from(statusSet).sort().forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        statusFilter.appendChild(option);
    });
    
    // 只有在有数据且表格存在时才显示数据
    if (allRecords.length > 0 && document.getElementById('dataTableBody')) {
        displayData();
    }
});

// 数据过滤
function filterData() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const salesPersonFilter = document.getElementById('salesPersonFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    filteredRecords = allRecords.filter(record => {
        // 搜索过滤
        const matchesSearch = !searchTerm || 
            (record['编号'] && record['编号'].toString().toLowerCase().includes(searchTerm)) ||
            (record['客户'] && record['客户'].toLowerCase().includes(searchTerm)) ||
            (record['销售人员'] && record['销售人员'].toLowerCase().includes(searchTerm));
        
        // 销售人员过滤
        const matchesSalesPerson = !salesPersonFilter || record['销售人员'] === salesPersonFilter;
        
        // {{ _("status_filter") }}
        const matchesStatus = !statusFilter || record['订单状态'] === statusFilter;
        
        // {{ _("date_filter") }}
        let matchesDate = true;
        if (startDate || endDate) {
            const orderDate = record['{{ _("order_date") }}'];
            if (orderDate && orderDate !== 'None' && orderDate !== null) {
                const recordDate = new Date(orderDate);
                if (!isNaN(recordDate.getTime())) {
                    if (startDate && recordDate < new Date(startDate)) matchesDate = false;
                    if (endDate && recordDate > new Date(endDate)) matchesDate = false;
                } else {
                    matchesDate = !startDate && !endDate;
                }
            } else {
                matchesDate = !startDate && !endDate;
            }
        }
        
        return matchesSearch && matchesSalesPerson && matchesStatus && matchesDate;
    });
    
    currentPage = 1;
    displayData();
}

// 清除过滤器
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('salesPersonFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    filterData();
}

// 排序功能
let currentSortColumn = '';
let currentSortDirection = 'asc';

function sortData(column) {
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }
    
    // 更新排序图标
    document.querySelectorAll('[id^="sort-"]').forEach(icon => {
        icon.className = 'fas fa-sort';
    });
    const sortIcon = document.getElementById(`sort-${column}`);
    if (sortIcon) {
        sortIcon.className = currentSortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
    
    // 排序数据
    filteredRecords.sort((a, b) => {
        let valueA = a[column];
        let valueB = b[column];
        
        // 处理不同数据类型
                    if (['订单金额', '{{ _("quotation_order") }}金额', '订单数量', '{{ _("quotation_order") }}数量', '毛利率（%）'].includes(column)) {
            valueA = parseFloat(valueA) || 0;
            valueB = parseFloat(valueB) || 0;
        } else if (column === '{{ _("order_date") }}') {
            valueA = new Date(valueA || '1900-01-01');
            valueB = new Date(valueB || '1900-01-01');
        } else {
            valueA = (valueA || '').toString().toLowerCase();
            valueB = (valueB || '').toString().toLowerCase();
        }
        
        if (currentSortDirection === 'asc') {
            return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        } else {
            return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
        }
    });
    
    currentPage = 1;
    displayData();
}

// 显示数据
function displayData() {
    const tbody = document.getElementById('dataTableBody');
    if (!tbody) {
        return;
    }
    
    tbody.innerHTML = '';
    
    const start = (currentPage - 1) * pageSize;
    const end = Math.min(start + pageSize, filteredRecords.length);
    
    for (let i = start; i < end; i++) {
        const record = filteredRecords[i];
        const row = tbody.insertRow();
        
        row.innerHTML = `
            <td>${record['编号'] || ''}</td>
            <td>${record['{{ _("order_date") }}'] || ''}</td>
            <td>${record['销售人员'] || ''}</td>
            <td>${record['客户'] || ''}</td>
            <td>
                ${record['订单状态'] === '{{ _("sales_order") }}' ? '<span class="badge bg-success">{{ _("sales_order") }}</span>' : 
                  record['订单状态'] === '{{ _("quotation_order") }}' ? '<span class="badge bg-warning">{{ _("quotation_order") }}</span>' : 
                  '<span class="badge bg-secondary">' + (record['订单状态'] || '') + '</span>'}
            </td>

            <td class="text-end">$${record['订单金额'] ? parseFloat(record['订单金额']).toFixed(2) : '0.00'}</td>
            <td class="text-end">$${record['{{ _("quotation_order") }}金额'] ? parseFloat(record['{{ _("quotation_order") }}金额']).toFixed(2) : '0.00'}</td>
            <td class="text-center">${record['订单数量'] || 0}</td>
            <td class="text-center">${record['{{ _("quotation_order") }}数量'] || 0}</td>
        `;
    }
    
    updatePagination();
    updateRecordCount();
}

// 更新记录计数
function updateRecordCount() {
    const recordCount = document.getElementById('recordCount');
    if (recordCount) {
        recordCount.textContent = filteredRecords.length;
    }
}

// 更新分页
function updatePagination() {
    const totalPages = Math.ceil(filteredRecords.length / pageSize);
    const pageInfo = document.getElementById('pageInfo');
    const pagination = document.getElementById('pagination');
    
    if (!pageInfo || !pagination) return;
    
    // 更新页面信息
    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, filteredRecords.length);
    pageInfo.textContent = `显示 ${start}-${end} 条，共 ${filteredRecords.length} 条记录`;
    
    // 更新分页按钮
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // 上一页按钮
    const prevBtn = document.createElement('button');
    prevBtn.className = `btn btn-sm ${currentPage === 1 ? 'btn-outline-secondary disabled' : 'btn-outline-primary'}`;
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevBtn.onclick = () => currentPage > 1 && changePage(currentPage - 1);
    pagination.appendChild(prevBtn);
    
    // 页码按钮
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => changePage(i);
        pagination.appendChild(pageBtn);
    }
    
    // 下一页按钮
    const nextBtn = document.createElement('button');
    nextBtn.className = `btn btn-sm ${currentPage === totalPages ? 'btn-outline-secondary disabled' : 'btn-outline-primary'}`;
    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextBtn.onclick = () => currentPage < totalPages && changePage(currentPage + 1);
    pagination.appendChild(nextBtn);
}

// 切换页面
function changePage(page) {
    currentPage = page;
    displayData();
}

// 改变每页显示数量
function changePageSize() {
    pageSize = parseInt(document.getElementById('pageSize').value);
    currentPage = 1;
    displayData();
}

// 导出到Excel
function exportToExcel() {
                const headers = ['编号', '{{ _("order_date") }}', '销售人员', '客户', '订单状态', '订单金额', '{{ _("quotation_order") }}金额', '订单数量', '{{ _("quotation_order") }}数量'];
    let csvContent = headers.join(',') + '\n';
    
    filteredRecords.forEach(record => {
        const row = headers.map(header => {
            let value = record[header] || '';
            if (value && value.toString().includes(',')) {
                value = `"${value}"`;
            }
            return value;
        }).join(',');
        csvContent += row + '\n';
    });
    
    // 创建并下载文件
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '转换后销售数据_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}