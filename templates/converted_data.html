[% extends "base.html" %]

[% block title %]Converted Sales Data[% endblock %]

[% block content %]
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12">
            <!-- Page Title -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">
                            <i class="fas fa-table me-3 page-icon"></i>
                            Converted Sales Data
                        </h1>
                        <p class="page-subtitle">View converted data including order amount, [[ _("quotation_order") ]] amount, conversion rate and other fields</p>
                    </div>
                    <div>
                        <a href="/view_imported_data" class="btn btn-outline-secondary">
                            <i class="fas fa-eye me-1"></i>View Original Data
                        </a>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="window.close()">
                            <i class="fas fa-times me-1"></i>Close
                        </button>
                        <a href="/" class="btn btn-primary ms-2">
                            <i class="fas fa-home me-1"></i>Return to Home
                        </a>
                    </div>
                </div>
            </div>

            [% if error %]
            <!-- [[ _("error_message") ]] -->
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                [[ error ]]
            </div>
            [% elif data %]
            <!-- [[ _("current_filter_settings_tip") ]] -->
            [% if system_settings.get('import_filter_min_amount') or system_settings.get('import_filter_sales_person') or system_settings.get('import_filter_customer') or system_settings.get('import_filter_start_date') or system_settings.get('import_filter_end_date') or system_settings.get('import_filter_order_status') %]
            <div class="alert alert-warning" role="alert">
                <h6 class="alert-heading">
                    <i class="fas fa-filter me-2"></i>Currently applied import filter conditions
                </h6>
                <div class="row">
                    <div class="col-md-12">
                        <ul class="mb-2">
                            [% if system_settings.get('import_filter_min_amount') %]
                            <li><strong>[[ _("min_amount_threshold") ]]:</strong> ≥ $[[ system_settings.get('import_filter_min_amount') ]]</li>
                            [% endif %]
                            [% if system_settings.get('import_filter_sales_person') %]
                            <li><strong>Sales Person:</strong> [[ system_settings.get('import_filter_sales_person') ]]</li>
                            [% endif %]
                            [% if system_settings.get('import_filter_customer') %]
                            <li><strong>Customer:</strong> [[ system_settings.get('import_filter_customer') ]]</li>
                            [% endif %]
                            [% if system_settings.get('import_filter_start_date') %]
                            <li><strong>[[ _("start_date") ]]:</strong> [[ system_settings.get('import_filter_start_date') ]]</li>
                            [% endif %]
                            [% if system_settings.get('import_filter_end_date') %]
                            <li><strong>[[ _("end_date") ]]:</strong> [[ system_settings.get('import_filter_end_date') ]]</li>
                            [% endif %]
                            [% if system_settings.get('import_filter_order_status') %]
                            <li><strong>Order Status:</strong> [[ system_settings.get('import_filter_order_status') ]]</li>
                            [% endif %]
                        </ul>
                        <p class="mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            The displayed data has been filtered according to the above filter conditions. To modify filter settings, please go to
                            <a href="/admin" class="alert-link">Admin Dashboard → Order Import Filter Settings</a>
                        </p>
                    </div>
                </div>
            </div>
            [% endif %]
            
            <!-- Data Statistics Information -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Data Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-list-ol text-primary me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">Total Records</div>
                                    <div class="h4 mb-0 text-primary">[[ total_records ]]</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-shopping-cart text-success me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">[[ _("sales_order") ]] Count</div>
                                    <div class="h4 mb-0 text-success">[[ data | selectattr('Order Status', 'equalto', '[[ _("sales_order") ]]') | list | length ]]</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-invoice text-warning me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">[[ _("quotation_order") ]] Count</div>
                                    <div class="h4 mb-0 text-warning">[[ data | selectattr('Order Status', 'equalto', '[[ _("quotation_order") ]]') | list | length ]]</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-percentage text-info me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold">Overall Conversion Rate</div>
                                    <div class="h4 mb-0 text-info">
                                        [% set total_order_amount = data | map(attribute='Order Amount') | select | list | sum %]
                                        [% set total_quotation_amount = data | map(attribute='[[ _("quotation_order") ]] Amount') | select | list | sum %]
                                        [% if total_quotation_amount > 0 %]
                                            [[ "%.1f" | format((total_order_amount / total_quotation_amount) * 100) ]]%
                                        [% else %]
                                            0.0%
                                        [% endif %]
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [[ _("data_filter_and_search") ]] -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">[[ _("data_filter") ]]</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">[[ _("search") ]]</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="[[ _("search_number_customer_salesperson") ]]" onkeyup="filterData()">
                        </div>
                        <div class="col-md-2">
                            <label for="salesPersonFilter" class="form-label">Sales Person</label>
                            <select class="form-control" id="salesPersonFilter" onchange="filterData()">
                                <option value="">All</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="statusFilter" class="form-label">Order Status</label>
                            <select class="form-control" id="statusFilter" onchange="filterData()">
                                <option value="">All</option>
                                <!-- Status options will be dynamically generated from converted data via JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="startDate" class="form-label">[[ _("start_date") ]]</label>
                            <input type="date" class="form-control" id="startDate" onchange="filterData()">
                        </div>
                        <div class="col-md-2">
                            <label for="endDate" class="form-label">[[ _("end_date") ]]</label>
                            <input type="date" class="form-control" id="endDate" onchange="filterData()">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Converted Data List
                        <span id="recordCount" class="badge bg-secondary ms-2">0</span>
                    </h5>
                    <div>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-1"></i>ExportExcel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="dataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="cursor: pointer;" onclick="sortData('Number')">Number <i id="sort-Number" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('[[ _("order_date") ]]')">[[ _("order_date") ]] <i id="sort-[[ _("order_date") ]]" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('Sales Person')">Sales Person <i id="sort-Sales Person" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('Customer')">Customer <i id="sort-Customer" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('Order Status')">Order Status <i id="sort-Order Status" class="fas fa-sort"></i></th>

                                    <th style="cursor: pointer;" onclick="sortData('Order Amount')">Order Amount <i id="sort-Order Amount" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('[[ _("quotation_order") ]] Amount')">[[ _("quotation_order") ]] Amount <i id="sort-[[ _("quotation_order") ]] Amount" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('Order Quantity')">Order Quantity <i id="sort-Order Quantity" class="fas fa-sort"></i></th>
                                    <th style="cursor: pointer;" onclick="sortData('[[ _("quotation_order") ]] Count')">[[ _("quotation_order") ]] Count <i id="sort-[[ _("quotation_order") ]] Count" class="fas fa-sort"></i></th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <!-- Data will be populated via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="d-flex align-items-center">
                            <span class="me-2">Items per page:</span>
                            <select class="form-select form-select-sm" id="pageSize" style="width: auto;" onchange="changePageSize()">
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                        <div id="pageInfo" class="text-muted"></div>
                        <div id="pagination" class="d-flex gap-1"></div>
                    </div>
                </div>
            </div>
            [% else %]
            <!-- No data [[ _("tip") ]] -->
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                No data available, please import sales data first.
            </div>
            [% endif %]
        </div>
    </div>
</div>
[% endblock %]

[% block extra_js %]
<script>
let allRecords = [[ data | tojson if data else '[]' ]];
let filteredRecords = [...allRecords];
let currentPage = 1;
let pageSize = 25;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Populate Sales Person filter
    const salesPersonSet = new Set();
    allRecords.forEach(record => {
        if (record['Sales Person']) {
            salesPersonSet.add(record['Sales Person']);
        }
    });
    
    const salesPersonFilter = document.getElementById('salesPersonFilter');
    Array.from(salesPersonSet).sort().forEach(person => {
        const option = document.createElement('option');
        option.value = person;
        option.textContent = person;
        salesPersonFilter.appendChild(option);
    });
    
    // Populate order [[ _("status_filter") ]] filter - dynamically get from converted data
    const statusSet = new Set();
    allRecords.forEach(record => {
        if (record['Order Status']) {
            statusSet.add(record['Order Status']);
        }
    });
    
    const statusFilter = document.getElementById('statusFilter');
    Array.from(statusSet).sort().forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        statusFilter.appendChild(option);
    });
    
    // Only show data when data exists and table exists
    if (allRecords.length > 0 && document.getElementById('dataTableBody')) {
        displayData();
    }
});

// [[ _("data_filter") ]]
function filterData() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const salesPersonFilter = document.getElementById('salesPersonFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    filteredRecords = allRecords.filter(record => {
        // [[ _("search") ]] filter
        const matchesSearch = !searchTerm || 
            (record['Number'] && record['Number'].toString().toLowerCase().includes(searchTerm)) ||
            (record['Customer'] && record['Customer'].toLowerCase().includes(searchTerm)) ||
            (record['Sales Person'] && record['Sales Person'].toLowerCase().includes(searchTerm));
        
        // Sales Person filter
        const matchesSalesPerson = !salesPersonFilter || record['Sales Person'] === salesPersonFilter;
        
        // [[ _("status_filter") ]]
        const matchesStatus = !statusFilter || record['Order Status'] === statusFilter;
        
        // [[ _("date_filter") ]]
        let matchesDate = true;
        if (startDate || endDate) {
            const orderDate = record['[[ _("order_date") ]]'];
            if (orderDate && orderDate !== 'None' && orderDate !== null) {
                const recordDate = new Date(orderDate);
                if (!isNaN(recordDate.getTime())) {
                    if (startDate && recordDate < new Date(startDate)) matchesDate = false;
                    if (endDate && recordDate > new Date(endDate)) matchesDate = false;
                } else {
                    matchesDate = !startDate && !endDate;
                }
            } else {
                matchesDate = !startDate && !endDate;
            }
        }
        
        return matchesSearch && matchesSalesPerson && matchesStatus && matchesDate;
    });
    
    currentPage = 1;
    displayData();
}

// Clear filters
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('salesPersonFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    filterData();
}

// Sorting functionality
let currentSortColumn = '';
let currentSortDirection = 'asc';

function sortData(column) {
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }
    
    // Update sort icons
    document.querySelectorAll('[id^="sort-"]').forEach(icon => {
        icon.className = 'fas fa-sort';
    });
    const sortIcon = document.getElementById(`sort-${column}`);
    if (sortIcon) {
        sortIcon.className = currentSortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
    
    // Sort data
    filteredRecords.sort((a, b) => {
        let valueA = a[column];
        let valueB = b[column];
        
        // Handle different data types
                    if (['Order Amount', '[[ _("quotation_order") ]] Amount', 'Order Quantity', '[[ _("quotation_order") ]] Count', 'Gross Profit Margin (%)'].includes(column)) {
            valueA = parseFloat(valueA) || 0;
            valueB = parseFloat(valueB) || 0;
        } else if (column === '[[ _("order_date") ]]') {
            valueA = new Date(valueA || '1900-01-01');
            valueB = new Date(valueB || '1900-01-01');
        } else {
            valueA = (valueA || '').toString().toLowerCase();
            valueB = (valueB || '').toString().toLowerCase();
        }
        
        if (currentSortDirection === 'asc') {
            return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        } else {
            return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
        }
    });
    
    currentPage = 1;
    displayData();
}

// Show data
function displayData() {
    const tbody = document.getElementById('dataTableBody');
    if (!tbody) {
        return;
    }
    
    tbody.innerHTML = '';
    
    const start = (currentPage - 1) * pageSize;
    const end = Math.min(start + pageSize, filteredRecords.length);
    
    for (let i = start; i < end; i++) {
        const record = filteredRecords[i];
        const row = tbody.insertRow();
        
        row.innerHTML = `
            <td>${record['Number'] || ''}</td>
            <td>${record['[[ _("order_date") ]]'] || ''}</td>
            <td>${record['Sales Person'] || ''}</td>
            <td>${record['Customer'] || ''}</td>
            <td>
                ${record['Order Status'] === '[[ _("sales_order") ]]' ? '<span class="badge bg-success">[[ _("sales_order") ]]</span>' : 
                  record['Order Status'] === '[[ _("quotation_order") ]]' ? '<span class="badge bg-warning">[[ _("quotation_order") ]]</span>' : 
                  '<span class="badge bg-secondary">' + (record['Order Status'] || '') + '</span>'}
            </td>

            <td class="text-end">$${record['Order Amount'] ? parseFloat(record['Order Amount']).toFixed(2) : '0.00'}</td>
            <td class="text-end">$${record['[[ _("quotation_order") ]] Amount'] ? parseFloat(record['[[ _("quotation_order") ]] Amount']).toFixed(2) : '0.00'}</td>
            <td class="text-center">${record['Order Quantity'] || 0}</td>
            <td class="text-center">${record['[[ _("quotation_order") ]] Count'] || 0}</td>
        `;
    }
    
    updatePagination();
    updateRecordCount();
}

// Update record count
function updateRecordCount() {
    const recordCount = document.getElementById('recordCount');
    if (recordCount) {
        recordCount.textContent = filteredRecords.length;
    }
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredRecords.length / pageSize);
    const pageInfo = document.getElementById('pageInfo');
    const pagination = document.getElementById('pagination');
    
    if (!pageInfo || !pagination) return;
    
    // Update page information
    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, filteredRecords.length);
    pageInfo.textContent = `[[ _("showing_records") ]]`.replace('{start}', start).replace('{end}', end).replace('{total}', filteredRecords.length);
    
    // Update pagination按钮
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous page button
    const prevBtn = document.createElement('button');
    prevBtn.className = `btn btn-sm ${currentPage === 1 ? 'btn-outline-secondary disabled' : 'btn-outline-primary'}`;
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevBtn.onclick = () => currentPage > 1 && changePage(currentPage - 1);
    pagination.appendChild(prevBtn);
    
    // Page number button
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => changePage(i);
        pagination.appendChild(pageBtn);
    }
    
    // Next page button
    const nextBtn = document.createElement('button');
    nextBtn.className = `btn btn-sm ${currentPage === totalPages ? 'btn-outline-secondary disabled' : 'btn-outline-primary'}`;
    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextBtn.onclick = () => currentPage < totalPages && changePage(currentPage + 1);
    pagination.appendChild(nextBtn);
}

// Switch page
function changePage(page) {
    currentPage = page;
    displayData();
}

// Change items per page
function changePageSize() {
    pageSize = parseInt(document.getElementById('pageSize').value);
    currentPage = 1;
    displayData();
}

// Export to Excel
function exportToExcel() {
                const headers = ['Number', '[[ _("order_date") ]]', 'Sales Person', 'Customer', 'Order Status', 'Order Amount', '[[ _("quotation_order") ]] Amount', 'Order Quantity', '[[ _("quotation_order") ]] Count'];
    let csvContent = headers.join(',') + '\n';
    
    filteredRecords.forEach(record => {
        const row = headers.map(header => {
            let value = record[header] || '';
            if (value && value.toString().includes(',')) {
                value = `"${value}"`;
            }
            return value;
        }).join(',');
        csvContent += row + '\n';
    });
    
    // Create and download file
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Converted Sales Data_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
[% endblock %]